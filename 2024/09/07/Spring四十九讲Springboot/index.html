<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Spring四十九讲Springboot | 呆大王的博客</title><meta name="author" content="呆大王"><meta name="copyright" content="呆大王"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="bilibili黑马四十九讲SpringBoot 37.Boot 骨架项目使用 IDEA 创建 SpringBoot 项目时，会创建出 .mvn 目录、HELP.md、mvnw 和 mvnw.cmd 等不必要的文件。 Windows 下的Docker 这篇文章里介绍了如何在 windows 下安装 WSL。 进入 WSL，并输入 curl -G [https:&#x2F;&#x2F;start.sprin">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring四十九讲Springboot">
<meta property="og:url" content="https://daidawang.github.io/2024/09/07/Spring%E5%9B%9B%E5%8D%81%E4%B9%9D%E8%AE%B2Springboot/index.html">
<meta property="og:site_name" content="呆大王的博客">
<meta property="og:description" content="bilibili黑马四十九讲SpringBoot 37.Boot 骨架项目使用 IDEA 创建 SpringBoot 项目时，会创建出 .mvn 目录、HELP.md、mvnw 和 mvnw.cmd 等不必要的文件。 Windows 下的Docker 这篇文章里介绍了如何在 windows 下安装 WSL。 进入 WSL，并输入 curl -G [https:&#x2F;&#x2F;start.sprin">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202409072209125.png">
<meta property="article:published_time" content="2024-09-07T14:04:33.000Z">
<meta property="article:modified_time" content="2024-09-19T08:13:33.399Z">
<meta property="article:author" content="呆大王">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202409072209125.png"><link rel="shortcut icon" href="http://mms1.baidu.com/it/u=3426123179,1132541183&fm=253&app=120&f=JPEG?w=801&h=500"><link rel="canonical" href="https://daidawang.github.io/2024/09/07/Spring%E5%9B%9B%E5%8D%81%E4%B9%9D%E8%AE%B2Springboot/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.0.0-b1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = true
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring四十九讲Springboot',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-19 16:13:33'
}</script><link rel="stylesheet" href="/css/loading_gif.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(url(/img/background.jpg));"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://mms1.baidu.com/it/u=3426123179,1132541183&amp;fm=253&amp;app=120&amp;f=JPEG?w=801&amp;h=500" onerror="onerror=null;src='/img/ironheart.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我们</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202409072219173.png);"><nav id="nav"><span id="blog-info"><a href="/" title="呆大王的博客"><img class="site-icon" src="http://mms1.baidu.com/it/u=3426123179,1132541183&amp;fm=253&amp;app=120&amp;f=JPEG?w=801&amp;h=500" alt="Logo"/><span class="site-name">呆大王的博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我们</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Spring四十九讲Springboot</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-07T14:04:33.000Z" title="发表于 2024-09-07 22:04:33">2024-09-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-19T08:13:33.399Z" title="更新于 2024-09-19 16:13:33">2024-09-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/SpringBoot/">SpringBoot</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring四十九讲Springboot"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer" />





<p><a target="_blank" rel="noopener" href="https://player.bilibili.com/player.html?bvid=BV1P44y1N7QG&p=120&page=120&autoplay=0">bilibili黑马四十九讲SpringBoot</a></p>
<h1 id="37-Boot-骨架项目"><a href="#37-Boot-骨架项目" class="headerlink" title="37.Boot 骨架项目"></a>37.Boot 骨架项目</h1><p>使用 IDEA 创建 SpringBoot 项目时，会创建出 .mvn 目录、HELP.md、mvnw 和 mvnw.cmd 等不必要的文件。</p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/daidawang-jlmiu/tyvtug/ichft4exr7fpb3vg">Windows 下的Docker</a> 这篇文章里介绍了如何在 windows 下安装 WSL。</p>
<p>进入 WSL，并输入</p>
<p><code>curl -G [https://start.spring.io/pom.xml](https://start.spring.io/pom.xml) -d dependencies=web,mysql,mybatis -o pom.xml</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725523991159-c6d61622-5aaf-48ec-9c0d-c16afd7058f1.png"></p>
<p>查看当前目录：<code>pwd</code></p>
<p>手动指定路径并复制文件：</p>
<p> <code>cp /home/daidawang/pom.xml /mnt/c/Users/zhangzhiwei/Documents/demo</code></p>
<p>   <img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725524241814-bad6b082-036f-4508-9e7c-bf50a450d89c.png"></p>
<p>进入指定路径： <code>cd C:\Users\zhangzhiwei\Documents\demo</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725526887238-888d75a2-abd7-4a75-8676-878f5b315da3.png"></p>
<p>配置 idea 环境变量：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725525207686-7a3ccd54-bed2-48d9-8fe4-ce25b9af94c2.png"></p>
<p>将 IDEA64 变量添加到 PATH</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725525810215-3ae0d249-b255-49e3-bb5b-23905efc808d.png"></p>
<p>输入 <code>idea .\pom.xml</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725526952234-8caecc1e-b057-4d07-924d-17cb253c8cb8.png"></p>
<p>idea 根据 pom 创建项目：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725527019866-6f82da71-f1e3-486d-8fd7-eeb8162cfcb8.png">  </p>
<h1 id="38-构建-spring-war-项目"><a href="#38-构建-spring-war-项目" class="headerlink" title="38.构建 spring war 项目"></a>38.构建 spring war 项目</h1><h1 id="39-boot-启动流程"><a href="#39-boot-启动流程" class="headerlink" title="39.boot 启动流程"></a>39.boot 启动流程</h1><p>SpringBoot 的主启动类类似于：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BootApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BootApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>SpringApplication#run()</code> 方法是核心方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt; primarySource, String... args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> run(<span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123; primarySource &#125;, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终使用 <code>new</code> 关键字构造了 <code>SpringApplication</code> 对象,然后调用了下面非静态的 <code>run()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="literal">null</span>, primarySources);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//创建一个新的SpringApplication实例。</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.primarySources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">        getSpringFactoriesInstances(BootstrapRegistryInitializer.class));</span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="39-1-SpringApplication-构造分析"><a href="#39-1-SpringApplication-构造分析" class="headerlink" title="39.1 SpringApplication 构造分析"></a>39.1 SpringApplication 构造分析</h2><p>构造 SpringApplication 对象时做了如下几件事：</p>
<ol>
<li>获取 BeanDefinition 对象。根据各种来源 添加 BeanDefinition（xml、配置类等）</li>
<li>推断应用类型。</li>
<li>添加 ApplicationContext 初始化器</li>
<li>添加事件监听器</li>
<li>主类推断 。得到当前方法运行的所在类</li>
</ol>
<h3 id="获取-BeanDefinition-源"><a href="#获取-BeanDefinition-源" class="headerlink" title="获取 BeanDefinition 源"></a>获取 BeanDefinition 源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A39_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">application</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(A39_1.class);</span><br><span class="line">        application.setSources(Set.of(<span class="string">&quot;classpath:b01.xml&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> application.run(args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionName : context.getBeanDefinitionNames()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">resourceDescription</span> <span class="operator">=</span> context.getBeanFactory().getBeanDefinition(beanDefinitionName).getResourceDescription();</span><br><span class="line">            System.out.println(<span class="string">&quot;名称： &quot;</span>+beanDefinitionName +<span class="string">&quot; 资源来源： &quot;</span>+resourceDescription);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Bean2 <span class="title function_">bean2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">Web application could not be started as there was no org.springframework.boot.web.servlet.server.ServletWebServerFactory bean defined in the context.</span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">Check your application&#x27;s dependencies for a supported servlet web server.</span><br><span class="line">Check the configured web application type.</span><br></pre></td></tr></table></figure>

<p>这是因为添加了 <code>spring-boot-starter-web</code> 依赖，但 Spring 容器中并没有 <code>SerletWebServerFactory</code> 类型的 Bean。向容器添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TomcatServletWebServerFactory <span class="title function_">servletWebServerFactory</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">TomcatServletWebServerFactory</span> <span class="variable">tomcatServletWebServerFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>();</span><br><span class="line">    tomcatServletWebServerFactory.setPort(<span class="number">8081</span>);</span><br><span class="line">    <span class="keyword">return</span> tomcatServletWebServerFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">name: org.springframework.context.annotation.internalConfigurationAnnotationProcessor 来源: null</span><br><span class="line">name: org.springframework.context.annotation.internalAutowiredAnnotationProcessor 来源: null</span><br><span class="line">name: org.springframework.context.annotation.internalCommonAnnotationProcessor 来源: null</span><br><span class="line">name: org.springframework.context.event.internalEventListenerProcessor 来源: null</span><br><span class="line">name: org.springframework.context.event.internalEventListenerFactory 来源: null</span><br><span class="line">name: a39_1 来源: null</span><br><span class="line">name: org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory 来源: null</span><br><span class="line">name: bean2 来源: indi.mofan.a39.A39_1</span><br><span class="line">name: servletWebServerFactory 来源: indi.mofan.a39.A39_1</span><br></pre></td></tr></table></figure>

<p>来源为 <code>null</code>的 Bean 是 Spring 提供的 内置 Bean</p>
<p>使用 XML 配置文件添加 Bean，并利用 setSources() 方法设置创建 ApplicationContext 的其他来源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">SpringApplication</span> <span class="variable">spring</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(A39_1.class);</span><br><span class="line">    spring.setSources(Collections.singleton(<span class="string">&quot;classpath:b01.xml&quot;</span>));</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 b01.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bean1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.boot.A39_1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再次运行多出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">名称： bean1 资源来源： class path resource [b01.xml]</span><br></pre></td></tr></table></figure>



<h3 id="推断应用类型"><a href="#推断应用类型" class="headerlink" title="推断应用类型"></a>推断应用类型</h3><p>应用类型的推断在构造方法中可以看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip-- </span></span><br><span class="line">	<span class="comment">// 推断应用类型</span></span><br><span class="line">    <span class="built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>推断逻辑由 <code>WebApplicationType</code> 枚举中的 <code>deduceFromClasspath()</code> 方法完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> WebApplicationType <span class="title function_">deduceFromClasspath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ClassUtils.isPresent() 判断类路径下是否存在某个类</span></span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, <span class="literal">null</span>) &amp;&amp; !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, <span class="literal">null</span>)</span><br><span class="line">        &amp;&amp; !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="comment">// 响应式 Web 应用</span></span><br><span class="line">        <span class="keyword">return</span> WebApplicationType.REACTIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String className : SERVLET_INDICATOR_CLASSES) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(className, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// 非 Web 应用</span></span><br><span class="line">            <span class="keyword">return</span> WebApplicationType.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Web 应用</span></span><br><span class="line">    <span class="keyword">return</span> WebApplicationType.SERVLET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用反射调用 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Method</span> <span class="variable">deduceFromClasspath</span> <span class="operator">=</span> WebApplicationType.class.getDeclaredMethod(<span class="string">&quot;deduceFromClasspath&quot;</span>);</span><br><span class="line">    deduceFromClasspath.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;\t应用类型为: &quot;</span> + deduceFromClasspath.invoke(<span class="literal">null</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">应用类型为: SERVLET</span><br></pre></td></tr></table></figure>

<h3 id="添加-ApplicationContext-初始化器"><a href="#添加-ApplicationContext-初始化器" class="headerlink" title="添加 ApplicationContext 初始化器"></a>添加 ApplicationContext 初始化器</h3><p>调用 <code>SpringApplication#run()</code> 方法时会创建 <code>ApplicationContext</code>，最后调用 <code>ApplicationContext#refresh()</code> 方法完成初始化。</p>
<p>在创建与初始化完成之间的一些拓展功能就由 <code>ApplicationContext</code> 初始化器完成。</p>
<p>在 <code>SpringApplication</code> 的构造方法中，添加的初始化器信息从配置文件中读取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    <span class="comment">// 从配置文件中读取初始化器</span></span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>也可以调用 SpringApplication 对象的 addInitializers() 方法添加自定义初始化器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    spring.addInitializers(applicationContext -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (applicationContext <span class="keyword">instanceof</span> GenericApplicationContext) &#123;</span><br><span class="line">            <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (GenericApplicationContext) applicationContext;</span><br><span class="line">            context.registerBean(<span class="string">&quot;bean3&quot;</span>, Bean3.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建并初始化 Spring 容器</span></span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> spring.run(args);</span><br><span class="line">    Arrays.stream(context.getBeanDefinitionNames()).forEach(i -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;name: &quot;</span> + i +</span><br><span class="line">                           <span class="string">&quot; 来源: &quot;</span> + context.getBeanFactory().getBeanDefinition(i).getResourceDescription());</span><br><span class="line">    &#125;);</span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean3</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name: bean3 来源: null</span><br></pre></td></tr></table></figure>

<h3 id="添加事件监听器"><a href="#添加事件监听器" class="headerlink" title="添加事件监听器"></a>添加事件监听器</h3><p>与添加 <code>ApplicationContext</code> 初始化器一样，在 <code>SpringApplication</code> 的构造方法中，添加的事件监听器信息从配置文件中读取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    <span class="comment">// 从配置文件中读取事件监听器</span></span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以调用 SpringApplication 对象的 addListeners() 方法添加自定义事件监听器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    <span class="comment">// 输出所有事件信息</span></span><br><span class="line">    spring.addListeners(event -&gt; System.out.println(<span class="string">&quot;\t事件为: &quot;</span> + event));</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> 事件类型为: class org.springframework.boot.context.event.ApplicationStartingEvent</span><br><span class="line">事件类型为: class org.springframework.boot.context.event.ApplicationEnvironmentPreparedEvent</span><br><span class="line">事件类型为: class org.springframework.boot.context.event.ApplicationContextInitializedEvent</span><br><span class="line">事件类型为: class org.springframework.boot.context.event.ApplicationPreparedEvent</span><br><span class="line">事件类型为: class org.springframework.boot.web.servlet.context.ServletWebServerInitializedEvent</span><br><span class="line">事件类型为: class org.springframework.context.event.ContextRefreshedEvent</span><br><span class="line">事件类型为: class org.springframework.boot.context.event.ApplicationStartedEvent</span><br><span class="line">事件类型为: class org.springframework.boot.availability.AvailabilityChangeEvent</span><br><span class="line">事件类型为: class org.springframework.boot.context.event.ApplicationReadyEvent</span><br><span class="line">事件类型为: class org.springframework.boot.availability.AvailabilityChangeEvent</span><br><span class="line">事件类型为: class org.springframework.boot.availability.AvailabilityChangeEvent</span><br><span class="line">事件类型为: class org.springframework.context.event.ContextClosedEvent</span><br></pre></td></tr></table></figure>



<h3 id="主类推断"><a href="#主类推断" class="headerlink" title="主类推断"></a>主类推断</h3><p>主类推断在构造方法中可以看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    <span class="comment">// 主类推断</span></span><br><span class="line">    <span class="built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>推断逻辑由 <code>deduceMainApplicationClass()</code> 方法完成，利用反射调用该方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Method</span> <span class="variable">deduceMainApplicationClass</span> <span class="operator">=</span> SpringApplication.class.getDeclaredMethod(<span class="string">&quot;deduceMainApplicationClass&quot;</span>);</span><br><span class="line">    deduceMainApplicationClass.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;\t主类是: &quot;</span> + deduceMainApplicationClass.invoke(spring));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">主类推断为: class com.example.boot.A39_1</span><br></pre></td></tr></table></figure>



<h2 id="39-2-SpringApplication-run-分析"><a href="#39-2-SpringApplication-run-分析" class="headerlink" title="39.2 SpringApplication run 分析"></a>39.2 SpringApplication run 分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BootApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BootApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt; primarySource, String... args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> run(<span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123; primarySource &#125;, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造方法 <code>new SpringApplication(primarySources)</code>已经讲完，接下来看 <code>run()</code> 方法</p>
<h3 id="第一步-得到-SpringApplicationRunListeners"><a href="#第一步-得到-SpringApplicationRunListeners" class="headerlink" title="第一步 得到 SpringApplicationRunListeners"></a>第一步 得到 SpringApplicationRunListeners</h3><p>事件发布器</p>
<p>在执行 <code>run()</code> 方法时，先获取到 <code>SpringApplicationRunListeners</code>,它是事件发布器组合，</p>
<p>作用是：在 Spring Boot 启动各个阶段发布事件。</p>
<p><code>SpringApplicationRunListeners</code> 中使用 <code>SpringApplicationRunListener</code> 来描述单个事件发布器，</p>
<p><code>SpringApplicationRunListener</code> 是一个接口，它有且仅有一个实现类 <code>EventPublishingRunListener</code>。</p>
<p>事件发布器都是在配置文件中读取，从 <code>META-INFO/spring.factories</code> 中读取，该文件中有这样一句：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Run Listeners</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener=\</span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br></pre></td></tr></table></figure>



<p>从 <code>META-INFO/spring.factories</code>配置文件读取事件发布器信息，并发布各种事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: A39run方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A39</span> &#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>();</span><br><span class="line">        <span class="comment">//添加事件监听器</span></span><br><span class="line">        app.addListeners(e-&gt; System.out.println(e.getClass()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取事件发布器SpringApplicationRunListener的实现类名</span></span><br><span class="line">        List&lt;String&gt; names = SpringFactoriesLoader.loadFactoryNames</span><br><span class="line">                (SpringApplicationRunListener.class, A39.class.getClassLoader());</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(name);</span><br><span class="line"></span><br><span class="line">            Constructor&lt;?&gt; constructor = clazz.getConstructor(SpringApplication.class, String[].class);</span><br><span class="line">            <span class="type">SpringApplicationRunListener</span> <span class="variable">publisher</span> <span class="operator">=</span> (SpringApplicationRunListener) constructor.newInstance(app, args);</span><br><span class="line">            <span class="comment">//发布事件</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//springboot启动</span></span><br><span class="line">            <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultBootstrapContext</span>();</span><br><span class="line">            publisher.starting(bootstrapContext);</span><br><span class="line">            <span class="comment">//环境信息准备完毕</span></span><br><span class="line">            publisher.environmentPrepared(bootstrapContext, <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>());</span><br><span class="line">            <span class="comment">//在spring容器创建，并调用初始化器之后，发送下面事件</span></span><br><span class="line">            <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">            publisher.contextPrepared(context);</span><br><span class="line">            <span class="comment">//所有BeanDefinition加载完毕</span></span><br><span class="line">            publisher.contextLoaded(context);</span><br><span class="line">            <span class="comment">//spring容器初始化完成(refresh方法调用完毕)</span></span><br><span class="line">            context.refresh();</span><br><span class="line">            publisher.started(context,<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">//spring启动完毕</span></span><br><span class="line">            publisher.ready(context,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//启动失败</span></span><br><span class="line">            publisher.failed(context, <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;启动失败&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 SpringBoot 启动过程中，总共发布 7 种事件。</p>
<p>运行 main() 方法后，控制台打印出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br><span class="line">class org.springframework.boot.context.event.ApplicationStartingEvent</span><br><span class="line">class org.springframework.boot.context.event.ApplicationEnvironmentPreparedEvent</span><br><span class="line">class org.springframework.boot.context.event.ApplicationContextInitializedEvent</span><br><span class="line">class org.springframework.boot.context.event.ApplicationPreparedEvent</span><br><span class="line">class org.springframework.context.event.ContextRefreshedEvent</span><br><span class="line">class org.springframework.boot.context.event.ApplicationStartedEvent</span><br><span class="line">class org.springframework.boot.availability.AvailabilityChangeEvent</span><br><span class="line">class org.springframework.boot.context.event.ApplicationReadyEvent</span><br><span class="line">class org.springframework.boot.availability.AvailabilityChangeEvent</span><br><span class="line">class org.springframework.boot.context.event.ApplicationFailedEvent</span><br></pre></td></tr></table></figure>

<p>但打印出的事件种类并不止 7 种，这是因为包含了其他事件发布器发布的事件，</p>
<p><code>EventPublishingRunListener</code> 发布的事件的全限定类名包含 <code>boot.context.event</code>，</p>
<p>根据这个条件重新计算，恰好 7 个。</p>
<h3 id="第八到十一步-完成-Spring-容器创建"><a href="#第八到十一步-完成-Spring-容器创建" class="headerlink" title="第八到十一步 完成 Spring 容器创建"></a>第八到十一步 完成 Spring 容器创建</h3><ul>
<li>第八步：创建容器。在构造 <code>SpringApplication </code> 时推断出应用类型，使用应用类型直接创建</li>
<li>第九步：准备容器。回调最终构造 <code>SpringApplication</code>时添加的初始化器</li>
<li>第十步：加载 Bean 定义。从配置类、xml 配置文件读取 BeanDefintion，或者扫描某包路径下的 BeanDefintion 对象</li>
<li>第十一步：调用 <code>Application #refresh()</code> 方法，完成 Spring 容器的创建。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A39_3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">application</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>();</span><br><span class="line">        application.addInitializers(applicationContext -&gt; System.out.println(<span class="string">&quot;执行初始化器增强...&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 2. 封装启动 args&quot;</span>);</span><br><span class="line">        <span class="type">DefaultApplicationArguments</span> <span class="variable">arguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 8. 创建容器&quot;</span>);</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> createApplicationContext(WebApplicationType.SERVLET);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 9. 准备容器&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (ApplicationContextInitializer initializer : application.getInitializers()) &#123;</span><br><span class="line">            initializer.initialize(context);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 10. 加载 bean 定义&quot;</span>);</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getDefaultListableBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotatedBeanDefinitionReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotatedBeanDefinitionReader</span>(context.getDefaultListableBeanFactory());</span><br><span class="line">        reader.register(Config.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">XmlBeanDefinitionReader</span> <span class="variable">xmlBeanDefinitionReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanDefinitionReader</span>(beanFactory);</span><br><span class="line">        xmlBeanDefinitionReader.loadBeanDefinitions(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;b03.xml&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassPathBeanDefinitionScanner</span> <span class="variable">classPathBeanDefinitionScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathBeanDefinitionScanner</span>(beanFactory);</span><br><span class="line">        classPathBeanDefinitionScanner.scan(<span class="string">&quot;com.example.boot.sub&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 11. refresh 容器&quot;</span>);</span><br><span class="line">        context.refresh();</span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionName : context.getBeanDefinitionNames()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;name: &quot;</span>+beanDefinitionName+<span class="string">&quot; 来源： &quot;</span>+</span><br><span class="line">                               beanFactory.getBeanDefinition(beanDefinitionName).getResourceDescription());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 12. 执行 runner&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> GenericApplicationContext <span class="title function_">createApplicationContext</span><span class="params">(WebApplicationType type)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> REACTIVE:</span><br><span class="line">                context = <span class="keyword">new</span> <span class="title class_">AnnotationConfigReactiveWebServerApplicationContext</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SERVLET:</span><br><span class="line">                context = <span class="keyword">new</span> <span class="title class_">AnnotationConfigServletWebApplicationContext</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NONE:</span><br><span class="line">                context = <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean4</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean5</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean6</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        Bean5 <span class="title function_">bean5</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean5</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> ServletWebServerFactory <span class="title function_">servletWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">TomcatServletWebServerFactory</span> <span class="variable">webServerFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>();</span><br><span class="line">            webServerFactory.setPort(<span class="number">8081</span>);</span><br><span class="line">            <span class="keyword">return</span> webServerFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>b03.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bean4&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.example.boot.A39_3.Bean4&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font style="background-color:rgba(255, 255, 255, 0);">com.example.boot.sub 包下的 Bean：</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bean7</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 2. 封装启动 args</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 8. 创建容器</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 9. 准备容器</span><br><span class="line">执行初始化器增强...</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 10. 加载 bean 定义</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 11. refresh 容器</span><br><span class="line">name: org.springframework.context.annotation.internalConfigurationAnnotationProcessor 来源： null</span><br><span class="line">name: org.springframework.context.annotation.internalAutowiredAnnotationProcessor 来源： null</span><br><span class="line">name: org.springframework.context.annotation.internalCommonAnnotationProcessor 来源： null</span><br><span class="line">name: org.springframework.context.event.internalEventListenerProcessor 来源： null</span><br><span class="line">name: org.springframework.context.event.internalEventListenerFactory 来源： null</span><br><span class="line">name: a39_3.Config 来源： null</span><br><span class="line">name: bean4 来源： class path resource [b03.xml]</span><br><span class="line">name: bean7 来源： file [D:\workspace\advanced-spring\boot\target\classes\com\example\boot\sub\Bean7.class]</span><br><span class="line">name: org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory 来源： null</span><br><span class="line">name: bean5 来源： com.example.boot.A39_3$Config</span><br><span class="line">name: servletWebServerFactory 来源： com.example.boot.A39_3$Config</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 12. 执行 runner</span><br></pre></td></tr></table></figure>

<h3 id="第二步-封装启动-args"><a href="#第二步-封装启动-args" class="headerlink" title="第二步 封装启动 args"></a>第二步 封装启动 args</h3><p>调用 <code>DefaultApplicationArguments</code>的构造方法,传入 args :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 2. 封装启动 args&quot;</span>);</span><br><span class="line">    <span class="type">DefaultApplicationArguments</span> <span class="variable">arguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第十二步-执行-Runner"><a href="#第十二步-执行-Runner" class="headerlink" title="第十二步 执行 Runner"></a>第十二步 执行 Runner</h3><p>在 SpringBoot 启动成功后，可以执行一些 <code>Runner</code>，进行预处理和测试</p>
<p><code>Runner</code> 分为：CommandLineRunner , ApplicationRunner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它们都是 函数式接口，内部抽象方法长得也像，</p>
<ul>
<li>CommandLineRunner 直接接受启动参数</li>
<li>ApplicationRunner 接收封装后的 ApplicationArguments，即** 第二步** 封装得对象</li>
</ul>
<p>在配置类<font style="color:#bcbec4;background-color:#1e1f22;">Config</font>中添加这两种类型的 Bean:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ApplicationRunner <span class="title function_">applicationRunner</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApplicationRunner</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ApplicationRunner........&quot;</span>+Arrays.toString(args.getSourceArgs()));</span><br><span class="line">            System.out.println(args.getOptionNames());</span><br><span class="line">            System.out.println(args.getOptionValues(args.getOptionNames().iterator().next()));</span><br><span class="line">            System.out.println(args.getNonOptionArgs());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CommandLineRunner <span class="title function_">commandLineRunner</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommandLineRunner</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;CommandLineRunner........&quot;</span>+ Arrays.toString(args));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 2. 封装启动 args&quot;</span>);</span><br><span class="line">    <span class="type">DefaultApplicationArguments</span> <span class="variable">arguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 12. 执行 runner&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (CommandLineRunner runner : context.getBeansOfType(CommandLineRunner.class).values()) &#123;</span><br><span class="line">        runner.run(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ApplicationRunner runner : context.getBeansOfType(ApplicationRunner.class).values()) &#123;</span><br><span class="line">        runner.run(arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在运行 main 方法时,添加程序参数 <code>--server.port=8080 debug</code>:</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725707280868-6f4e17ae-cebc-4bd9-a1f9-b69e861557a2.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 12. 执行 runner</span><br><span class="line">ApplicationRunner........[--server.port=8081, DEBUG]</span><br><span class="line">[server.port]</span><br><span class="line">[8081]</span><br><span class="line">[DEBUG]</span><br><span class="line">CommandLineRunner........[--server.port=8081, DEBUG]</span><br></pre></td></tr></table></figure>

<h3 id="第三步-准备-Environment-添加命令行参数"><a href="#第三步-准备-Environment-添加命令行参数" class="headerlink" title="第三步 准备 Environment 添加命令行参数"></a>第三步 准备 Environment 添加命令行参数</h3><p><code>Environment</code>环境对象,是对配置信息的抽象</p>
<p>配置信息来源可以是:系统环境变量、properties 配置文件、yaml 配置文件等.</p>
<p>SpringBoot 提供了名为 <code>ApplicationEnvironment</code> 的类表示环境对象</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725709933750-0e843721-ebeb-4395-b573-468ce6e491ca.png"></p>
<p>默认情况下,创建的 <code>ApplictionEnvironment</code>对象中配置信息的来源只有两个:</p>
<ul>
<li>系统属性</li>
<li>系统变量</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Step3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">        env.getPropertySources().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;    </span><br></pre></td></tr></table></figure>



<blockquote>
<p>针对相同名称的配置信息,按照来源的先后顺序获取.</p>
</blockquote>
<h4 id="获取虚拟机参数"><a href="#获取虚拟机参数" class="headerlink" title="获取虚拟机参数"></a>获取虚拟机参数</h4><p>获取 JAVA_HOME 的配置信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ApplicationEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;JAVA_HOME&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\software\work\jdk\jdk8\jdk</span><br></pre></td></tr></table></figure>

<p>由于 <code>PropertiesPropertySource</code> 中并不存在名为 JAVA_HOME 的配置信息</p>
<p>所以从 <code>SystemEnvironmentPropertySource</code> 中获取 JAVA_HOME 的配置信息。</p>
<h4 id="获取命令行参数"><a href="#获取命令行参数" class="headerlink" title="获取命令行参数"></a>获取命令行参数</h4><p>在 IDEA 的 Run&#x2F;Debug Configurations 中的 VM options 添加 <code>-DJAVA_HOME=abc</code>，</p>
<p>使得 <code>PropertiesPropertySource</code> 中存在名为 JAVA_HOME 的配置信息：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725710609081-edc15d6b-b332-4e53-89a5-d258a1084526.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abc</span><br></pre></td></tr></table></figure>

<h4 id="获取properties-配置文件信息"><a href="#获取properties-配置文件信息" class="headerlink" title="获取properties 配置文件信息"></a>获取properties 配置文件信息</h4><p>如果要从配置文件 <code>application.properties</code> 中读取配置信息，可以添加配置信息的来源。配置文件的优先级最低，添加来源时调用 <code>addLast()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ApplicationEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">    env.getPropertySources().addLast(<span class="keyword">new</span> <span class="title class_">ResourcePropertySource</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;application.properties&quot;</span>)));</span><br><span class="line">    env.getPropertySources().forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;author.name&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">author.name</span>=<span class="string">daidawang</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">ResourcePropertySource &#123;name=&#x27;class path resource [application.properties]&#x27;&#125;</span><br><span class="line">abc</span><br><span class="line">daidawang</span><br></pre></td></tr></table></figure>

<h4 id="获取系统环境变量"><a href="#获取系统环境变量" class="headerlink" title="获取系统环境变量"></a>获取系统环境变量</h4><p>在 SpringBoot 中,这里 **<font style="color:#DF2A3F;">只 </font>**添加 <code>SimpleCommandLinePropertSource</code></p>
<p>并且它的优先级最高，使用 <code>addFirst()</code> 方法添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ApplicationEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">    env.getPropertySources().addLast(<span class="keyword">new</span> <span class="title class_">ResourcePropertySource</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;application.properties&quot;</span>)));</span><br><span class="line">    env.getPropertySources().addFirst(<span class="keyword">new</span> <span class="title class_">SimpleCommandLinePropertySource</span>(args));</span><br><span class="line">    env.getPropertySources().forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;author.name&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加程序参数 <code>--author.name=呆大王 </code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1725711123730-cf4a0277-248a-4bdc-8632-54e1c12d2b92.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SimpleCommandLinePropertySource &#123;name=&#x27;commandLineArgs&#x27;&#125;</span><br><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">ResourcePropertySource &#123;name=&#x27;class path resource [application.properties]&#x27;&#125;</span><br><span class="line">abc</span><br><span class="line">呆大王</span><br></pre></td></tr></table></figure>

<h3 id="第四步-添加-ConfigurationPropertySources"><a href="#第四步-添加-ConfigurationPropertySources" class="headerlink" title="第四步 添加 ConfigurationPropertySources"></a>第四步 添加 ConfigurationPropertySources</h3><p>创建 step4.properties 文件,内容如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user.first-name=dai</span><br><span class="line">user.middle_name=da</span><br><span class="line">user.lastName=wang</span><br></pre></td></tr></table></figure>

<p>读取文件内容:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ApplicationEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">    env.getPropertySources().addLast(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ResourcePropertySource</span>(<span class="string">&quot;step4&quot;</span>, <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;step4.properties&quot;</span>))</span><br><span class="line">    );</span><br><span class="line">    env.getPropertySources().forEach(System.out::println);</span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;user.first-name&quot;</span>));</span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;user.middle-name&quot;</span>));</span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;user.last-name&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>step4.properties 文件中配置信息的 key 是 user.middle_name，但在读取时，使用的是 user.middle-name；还有 user.lastName 的 key，但读取时使用 user.last-name。能读取成功吗？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">ResourcePropertySource &#123;name=&#x27;step4&#x27;&#125;</span><br><span class="line">George</span><br><span class="line">null</span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<p>显然是不行的，为了能读取成功，需要实现 <strong>松散绑定</strong>，添加 <code>ConfigurationPropertySources</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">    ConfigurationPropertySources.attach(env);</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationPropertySourcesPropertySource &#123;name=&#x27;configurationProperties&#x27;&#125;</span><br><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">ResourcePropertySource &#123;name=&#x27;step4&#x27;&#125;</span><br><span class="line">dai</span><br><span class="line">da</span><br><span class="line">wang</span><br></pre></td></tr></table></figure>



<h3 id="第五步-使用EnvironmentPostProcessorApplicationListener-进行环境对象后置处理"><a href="#第五步-使用EnvironmentPostProcessorApplicationListener-进行环境对象后置处理" class="headerlink" title="第五步 使用EnvironmentPostProcessorApplicationListener 进行环境对象后置处理"></a>第五步 使用EnvironmentPostProcessorApplicationListener 进行环境对象后置处理</h3><p>在第三步中 只 添加 <code>SimpleCommandLinePropertySource</code> 读取系统属性和系统变量，</p>
<p>而 读取 properties、YAML 配置文件的源就是在第五步中添加的。</p>
<p>完成这样功能需要使用到 	<code>EnvironmentPostProcessor</code>，其具体实现是 <code>ConfigDataEnvironmentPostProcessor</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">SpringApplication</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>();</span><br><span class="line">    <span class="type">ApplicationEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 增强前&quot;</span>);</span><br><span class="line">    env.getPropertySources().forEach(System.out::println);</span><br><span class="line">    <span class="type">ConfigDataEnvironmentPostProcessor</span> <span class="variable">processor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigDataEnvironmentPostProcessor</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DeferredLogs</span>(), <span class="keyword">new</span> <span class="title class_">DefaultBootstrapContext</span>()</span><br><span class="line">    );</span><br><span class="line">    processor1.postProcessEnvironment(env, app);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 增强后&quot;</span>);</span><br><span class="line">    env.getPropertySources().forEach(System.out::println);</span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;author.name&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="type">RandomValuePropertySourceEnvironmentPostProcessor</span> <span class="variable">processor2</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RandomValuePropertySourceEnvironmentPostProcessor</span>(<span class="keyword">new</span> <span class="title class_">DeferredLog</span>());</span><br><span class="line">    processor2.postProcessEnvironment(env, app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 增强前</span><br><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 增强后</span><br><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">OriginTrackedMapPropertySource &#123;name=&#x27;Config resource &#x27;class path resource [application.properties]&#x27; via location &#x27;optional:classpath:/&#x27;&#x27;&#125;</span><br><span class="line">&quot;daidawang&quot;</span><br></pre></td></tr></table></figure>

<p><code>EnvironmentPostProcessor</code> 还有一个有趣的实现：<code>RandomValuePropertySourceEnvironmentPostProcessor</code>，该实现提供了随机值的生成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 再次增强后&quot;</span>);</span><br><span class="line">    env.getPropertySources().forEach(System.out::println);</span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;random.string&quot;</span>));</span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;random.int&quot;</span>));</span><br><span class="line">    System.out.println(env.getProperty(<span class="string">&quot;random.uuid&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 再次增强后</span><br><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">RandomValuePropertySource &#123;name=&#x27;random&#x27;&#125;</span><br><span class="line">OriginTrackedMapPropertySource &#123;name=&#x27;Config resource &#x27;class path resource [application.properties]&#x27; via location &#x27;optional:classpath:/&#x27;&#x27;&#125;</span><br><span class="line">5ef4038a709215938cbd3e1c031f66dd</span><br><span class="line">1481116109</span><br><span class="line">18548e0b-8bad-458b-b38e-bf793aa24ced</span><br></pre></td></tr></table></figure>

<p>在 SpringBoot 中实现不是上述代码的方式添加后置处理器的,</p>
<p>同样会从 <code>META-INF/spring.factories</code> 配置文件读取并初始化处理器:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Environment Post Processors</span><br><span class="line">org.springframework.boot.env.EnvironmentPostProcessor=\</span><br><span class="line">org.springframework.boot.cloud.CloudFoundryVcapEnvironmentPostProcessor,\</span><br><span class="line">org.springframework.boot.context.config.ConfigDataEnvironmentPostProcessor,\</span><br><span class="line">org.springframework.boot.env.RandomValuePropertySourceEnvironmentPostProcessor,\</span><br><span class="line">org.springframework.boot.env.SpringApplicationJsonEnvironmentPostProcessor,\</span><br><span class="line">org.springframework.boot.env.SystemEnvironmentPropertySourceEnvironmentPostProcessor,\</span><br><span class="line">org.springframework.boot.reactor.DebugAgentEnvironmentPostProcessor</span><br></pre></td></tr></table></figure>

<p>SpringBoot 读取 <code>META-INF/spring.factories</code> 配置文件初始化环境后置处理器,再执行处理逻辑由</p>
<p>EnvironmentPostProcessorApplicationListener 完成.</p>
<p>它是事件监听器,同样在<code>META-INF/spring.factories</code> 配置文件中读取并初始化:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.ApplicationListener=\</span><br><span class="line">org.springframework.boot.ClearCachesApplicationListener,\</span><br><span class="line">org.springframework.boot.builder.ParentContextCloserApplicationListener,\</span><br><span class="line">org.springframework.boot.context.FileEncodingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.AnsiOutputApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.logging.LoggingApplicationListener,\</span><br><span class="line">org.springframework.boot.env.EnvironmentPostProcessorApplicationListener\</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要想该监听器成功监听到事件,需要第五步发布一个事件,而事件的发布由第一步获取的事件发布器完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">SpringApplication</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>();</span><br><span class="line">    app.addListeners(<span class="keyword">new</span> <span class="title class_">EnvironmentPostProcessorApplicationListener</span>());</span><br><span class="line">    <span class="type">ApplicationEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; names = SpringFactoriesLoader.loadFactoryNames(EnvironmentPostProcessor.class, Step5.class.getClassLoader());</span><br><span class="line">    names.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    <span class="type">EventPublishingRunListener</span> <span class="variable">publisher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventPublishingRunListener</span>(app, args);</span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 增强前&quot;</span>);</span><br><span class="line">    env.getPropertySources().forEach(System.out::println);</span><br><span class="line">    publisher.environmentPrepared(<span class="keyword">new</span> <span class="title class_">DefaultBootstrapContext</span>(), env);</span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 增强后&quot;</span>);</span><br><span class="line">    env.getPropertySources().forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.cloud.CloudFoundryVcapEnvironmentPostProcessor</span><br><span class="line">org.springframework.boot.context.config.ConfigDataEnvironmentPostProcessor</span><br><span class="line">org.springframework.boot.env.RandomValuePropertySourceEnvironmentPostProcessor</span><br><span class="line">org.springframework.boot.env.SpringApplicationJsonEnvironmentPostProcessor</span><br><span class="line">org.springframework.boot.env.SystemEnvironmentPropertySourceEnvironmentPostProcessor</span><br><span class="line">org.springframework.boot.reactor.DebugAgentEnvironmentPostProcessor</span><br><span class="line">org.springframework.boot.autoconfigure.integration.IntegrationPropertiesEnvironmentPostProcessor</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 增强前</span><br><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">SystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 增强后</span><br><span class="line">PropertiesPropertySource &#123;name=&#x27;systemProperties&#x27;&#125;</span><br><span class="line">OriginAwareSystemEnvironmentPropertySource &#123;name=&#x27;systemEnvironment&#x27;&#125;</span><br><span class="line">RandomValuePropertySource &#123;name=&#x27;random&#x27;&#125;</span><br><span class="line">OriginTrackedMapPropertySource &#123;name=&#x27;Config resource &#x27;class path resource [application.properties]&#x27; via location &#x27;optional:classpath:/&#x27;&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件 EnvironmentPostProcessor 实现有很多,但是上述打印的信息生效的不多,是否生效于项目的依赖配置无关.</p>
<h3 id="第六步-绑定配置信息到-SpringApplication"><a href="#第六步-绑定配置信息到-SpringApplication" class="headerlink" title="第六步 绑定配置信息到 SpringApplication"></a>第六步 绑定配置信息到 SpringApplication</h3><h4 id="ConfigurationProperties-注解的原理"><a href="#ConfigurationProperties-注解的原理" class="headerlink" title="@ConfigurationProperties 注解的原理"></a>@ConfigurationProperties 注解的原理</h4><p>使用 <code>@ConfigurationProperties</code>  注解可以指定一个前缀，SpringBoot 将根据指定的前缀和属性名称在配置文件中寻找对应的信息并完成注入，其底层是利用 <code>Binder</code> 实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A39ConfigurationProperties</span>原理 &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ApplicationEnvironment</span> <span class="variable">applicationEnvironment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">        applicationEnvironment.getPropertySources()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">ResourcePropertySource</span>(<span class="string">&quot;step4&quot;</span>,<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;step4.properties&quot;</span>)));</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> Binder.get(applicationEnvironment).bind(<span class="string">&quot;user&quot;</span>, User.class).get();</span><br><span class="line">        System.out.println(user);</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        Binder.get(applicationEnvironment).bind(<span class="string">&quot;user&quot;</span>, Bindable.ofInstance(user1));</span><br><span class="line">        System.out.println(user1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String lastName;</span><br><span class="line">        <span class="keyword">private</span> String middleName;</span><br><span class="line">        <span class="keyword">private</span> String firstName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>step4.properties : </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user.first-name</span>=<span class="string">dai</span></span><br><span class="line"><span class="attr">user.middle_name</span>=<span class="string">da</span></span><br><span class="line"><span class="attr">user.lastName</span>=<span class="string">wang</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A39ConfigurationProperties原理.User(lastName=wang, middleName=da, firstName=dai)</span><br><span class="line">A39ConfigurationProperties原理.User(lastName=wang, middleName=da, firstName=dai)</span><br></pre></td></tr></table></figure>

<h4 id="绑定配置信息到-SpringApplication"><a href="#绑定配置信息到-SpringApplication" class="headerlink" title="绑定配置信息到 SpringApplication"></a>绑定配置信息到 SpringApplication</h4><p>在第六步中，绑定 <code>spring.main</code> 前缀的配置信息到 <code>SpringApplication</code> 对象也是利用了 <code>Binder</code>。</p>
<p>假设 <code>step6.properties</code> 配置文件的信息如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.main.banner-mode</span>=<span class="string">off</span></span><br><span class="line"><span class="attr">spring.main.lazy-initialization</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: A39run方法6步 绑定spring.main 前缀的配置信息到 SpringApplication 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 读取配置文件并绑定到SpringApplication</span></span><br><span class="line"><span class="comment"> *              通过<span class="doctag">@ConfigurationProperties</span> 的原理Binder 将配置文件中的属性绑定到 SpringApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/9</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A39run</span>方法<span class="number">6</span>步 &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, IllegalAccessException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">ApplicationEnvironment</span> <span class="variable">applicationEnvironment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">        applicationEnvironment.getPropertySources()</span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">ResourcePropertySource</span>(<span class="string">&quot;step6&quot;</span>,<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;step6.properties&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">application</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>();</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">SpringApplication</span>&gt; clazz = application.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bannerMode</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;bannerMode&quot;</span>);</span><br><span class="line">        bannerMode.setAccessible(Boolean.TRUE);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">lazyInitialization</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lazyInitialization&quot;</span>);</span><br><span class="line">        lazyInitialization.setAccessible(Boolean.TRUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定前</span></span><br><span class="line">        System.out.println(bannerMode.get(application));</span><br><span class="line">        System.out.println(lazyInitialization.get(application));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定</span></span><br><span class="line">        Binder.get(applicationEnvironment).bind(<span class="string">&quot;spring.main&quot;</span>, Bindable.ofInstance(application));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定后</span></span><br><span class="line">        System.out.println(bannerMode.get(application));</span><br><span class="line">        System.out.println(lazyInitialization.get(application));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONSOLE</span><br><span class="line">false</span><br><span class="line">OFF</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<h3 id="第七步-打印-Banner"><a href="#第七步-打印-Banner" class="headerlink" title="第七步 打印 Banner"></a>第七步 打印 Banner</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: A39run方法7步</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/9</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A39run</span>方法<span class="number">7</span>步 &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationEnvironment</span> <span class="variable">applicationEnvironment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">        <span class="type">SpringApplicationBannerPrinter</span> <span class="variable">springApplicationBannerPrinter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplicationBannerPrinter</span>(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultResourceLoader</span>(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SpringBootBanner</span>()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"> printer.print(env, A39run方法<span class="number">7</span>步.class, System.out);  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除此之外还可以自定义文字和图片 Banner，文字 Banner 的文件类型需要是 txt，图片 Banner 的文件类型需要是 gif。</p>
<p>文字:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测试文字 banner</span></span><br><span class="line">    env.getPropertySources().addLast(<span class="keyword">new</span> <span class="title class_">MapPropertySource</span>(</span><br><span class="line">        <span class="string">&quot;custom&quot;</span>,</span><br><span class="line">        Collections.singletonMap(<span class="string">&quot;spring.banner.location&quot;</span>, <span class="string">&quot;banner1.txt&quot;</span>)</span><br><span class="line">    ));</span><br><span class="line">    printer.print(env, A39run方法<span class="number">7</span>步.class, System.out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文字 Banner 可以从 <a target="_blank" rel="noopener" href="https://www.lddgo.net/string/text-to-ascii-art">网站</a> 上自定义.</p>
<p>获取 Spring 或 SpringBoot 的版本号可以使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;SpringBoot: &quot;</span> + SpringBootVersion.getVersion());</span><br><span class="line">System.out.println(<span class="string">&quot;Spring: &quot;</span> + SpringVersion.getVersion());</span><br></pre></td></tr></table></figure>



<h3 id="步骤总结"><a href="#步骤总结" class="headerlink" title="步骤总结"></a>步骤总结</h3><ol>
<li>得到 SpringApplicationRunListeners 事件发布器</li>
</ol>
<ul>
<li>发布 starting 事件 1️⃣</li>
</ul>
<ol start="2">
<li>将 main 方法的参数 封装<font style="background-color:rgba(255, 255, 255, 0);">ApplicationArguments 对象(此对象将参数分为两类a选项参数 –开头.可添加到命令行 b非选项参数)</font></li>
<li>准备 environment 并添加选项参数(命令行参数)</li>
<li>松绑定 , ConfigurationPropertySources 处理</li>
</ol>
<ul>
<li>发布 environmentPrepared 事件 ,表示environment已经准备 2️⃣</li>
</ul>
<ol start="5">
<li>通过spring.factories 里找到事件监听器 EnvironmentPostProcessorApplicationListener , 调用<font style="background-color:rgba(255, 255, 255, 0);">environmentPrepared 方法增强environment,例如随机数的源和读取 application.properties 的源</font></li>
<li>绑定 spring.main 前缀的 key 到 SpringApplication 对象</li>
<li>打印 Banner</li>
<li>创建容器</li>
<li>准备容器,应用初始化器增强 ApplicationContext</li>
</ol>
<ul>
<li>发布 contextPrepared 事件,表示容器创建好并调用初始化器 3️⃣</li>
</ul>
<ol start="10">
<li>获取所有 BeanDefinition 源(xml、配置类、组件扫描) , 加载<font style="background-color:rgba(255, 255, 255, 0);"> BeanDefinition 到 ApplicationContext 容器</font></li>
</ol>
<ul>
<li>发布 contextLoaded 事件4️⃣</li>
</ul>
<ol start="11">
<li>refresh 容器,调用 Bean 工厂后置处理器 、bean 后置处理器、初始化单例 bean</li>
</ol>
<ul>
<li>发布 started 事件,表示 ApplicationContext 准备好了 5️⃣</li>
</ul>
<ol start="12">
<li>调用实现 ApplicationRunner 或者 CommandLineRunner 的 bean</li>
</ol>
<ul>
<li>发布 running 事件 6️⃣</li>
<li>这其中有异常，发布 Application Failed 事件 7️⃣</li>
</ul>
<p>步骤对应的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> createBootstrapContext();</span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="comment">//1.得到 SpringApplicationRunListeners 事件发布器</span></span><br><span class="line">    <span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);</span><br><span class="line">    <span class="comment">//发布 starting 事件 1️⃣</span></span><br><span class="line">    listeners.starting(bootstrapContext, <span class="built_in">this</span>.mainApplicationClass);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//2.将 main 方法的参数 封装ApplicationArguments 对象(此对象将参数分为两类a选项参数 --开头.可添加到命令行 b非选项参数)</span></span><br><span class="line">        <span class="type">ApplicationArguments</span> <span class="variable">applicationArguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line">        <span class="comment">//进入prepareEnvironment方法</span></span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line">        configureIgnoreBeanInfo(environment);</span><br><span class="line">        <span class="comment">//7.打印 Banner</span></span><br><span class="line">        <span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);</span><br><span class="line">        <span class="comment">//8.创建容器</span></span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        context.setApplicationStartup(<span class="built_in">this</span>.applicationStartup);</span><br><span class="line">        <span class="comment">//进入prepareContext</span></span><br><span class="line">        prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="comment">//11.refresh 容器,调用 Bean 工厂后置处理器 、bean 后置处理器、初始化单例 bean</span></span><br><span class="line">        refreshContext(context);</span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">timeTakenToStartup</span> <span class="operator">=</span> Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logStartupInfo) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">StartupInfoLogger</span>(<span class="built_in">this</span>.mainApplicationClass).logStarted(getApplicationLog(), timeTakenToStartup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//发布 started 事件</span></span><br><span class="line">        listeners.started(context, timeTakenToStartup);</span><br><span class="line">        <span class="comment">//12.调用实现 ApplicationRunner 或者 CommandLineRunner 的 bean</span></span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, listeners);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">timeTakenToReady</span> <span class="operator">=</span> Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">        <span class="comment">//发布 running 事件</span></span><br><span class="line">        listeners.ready(context, timeTakenToReady);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="comment">//这其中有异常，发布 Application Failed 事件</span></span><br><span class="line">        handleRunFailure(context, ex, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">                                                       DefaultBootstrapContext bootstrapContext, ApplicationArguments applicationArguments)</span> &#123;</span><br><span class="line">        <span class="comment">// Create and configure the environment</span></span><br><span class="line">        <span class="comment">//3.准备 environment</span></span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> getOrCreateEnvironment();</span><br><span class="line">        <span class="comment">// 并添加选项参数(命令行参数)</span></span><br><span class="line">        configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">        <span class="comment">//4.松绑定</span></span><br><span class="line">        ConfigurationPropertySources.attach(environment);</span><br><span class="line">        <span class="comment">//发布 environmentPrepared 事件 ,表示environment已经准备</span></span><br><span class="line">        <span class="comment">//5.通过spring.factories 里找到事件监听器 EnvironmentPostProcessorApplicationListener ,</span></span><br><span class="line">        <span class="comment">//调用environmentPrepared 方法增强environment,例如随机数的源和读取 application.properties 的源</span></span><br><span class="line">        listeners.environmentPrepared(bootstrapContext, environment);</span><br><span class="line">        DefaultPropertiesPropertySource.moveToEnd(environment);</span><br><span class="line">        Assert.state(!environment.containsProperty(<span class="string">&quot;spring.main.environment-prefix&quot;</span>),</span><br><span class="line">                <span class="string">&quot;Environment prefix cannot be set via properties.&quot;</span>);</span><br><span class="line">        <span class="comment">//6.绑定 spring.main 前缀的 key 到 SpringApplication 对象</span></span><br><span class="line">        bindToSpringApplication(environment);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">            <span class="type">EnvironmentConverter</span> <span class="variable">environmentConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EnvironmentConverter</span>(getClassLoader());</span><br><span class="line">            environment = environmentConverter.convertEnvironmentIfNecessary(environment, deduceEnvironmentClass());</span><br><span class="line">        &#125;</span><br><span class="line">        ConfigurationPropertySources.attach(environment);</span><br><span class="line">        <span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(DefaultBootstrapContext bootstrapContext, ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">                            ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">                            ApplicationArguments applicationArguments, Banner printedBanner)</span> &#123;</span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    <span class="comment">//9.准备容器,应用初始化器增强 ApplicationContext</span></span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    bootstrapContext.close(context);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.logStartupInfo) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == <span class="literal">null</span>);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">    beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">    <span class="keyword">if</span> (printedBanner != <span class="literal">null</span>) &#123;</span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> AbstractAutowireCapableBeanFactory) &#123;</span><br><span class="line">        ((AbstractAutowireCapableBeanFactory) beanFactory).setAllowCircularReferences(<span class="built_in">this</span>.allowCircularReferences);</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) &#123;</span><br><span class="line">            ((DefaultListableBeanFactory) beanFactory)</span><br><span class="line">                    .setAllowBeanDefinitionOverriding(<span class="built_in">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.lazyInitialization) &#123;</span><br><span class="line">        context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">LazyInitializationBeanFactoryPostProcessor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">SpringApplication</span>.PropertySourceOrderingBeanFactoryPostProcessor(context));</span><br><span class="line">    <span class="comment">// Load the sources</span></span><br><span class="line">    <span class="comment">//10.获取所有 BeanDefinition 源(xml、配置类、组件扫描) , 加载 BeanDefinition 到 ApplicationContext 容器</span></span><br><span class="line">    Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">    Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">    load(context, sources.toArray(<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]));</span><br><span class="line">    <span class="comment">//发布 contextLoaded 事件</span></span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="40-Tomcat-内嵌容器"><a href="#40-Tomcat-内嵌容器" class="headerlink" title="40.Tomcat 内嵌容器"></a>40.Tomcat 内嵌容器</h1><h1 id="41-自动配置"><a href="#41-自动配置" class="headerlink" title="41.自动配置"></a>41.自动配置</h1><h2 id="41-1-自动配置原理"><a href="#41-1-自动配置原理" class="headerlink" title="41.1 自动配置原理"></a>41.1 自动配置原理</h2><p>创建以下类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 模拟第三方配置类</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguration1</span>&#123;</span><br><span class="line">       <span class="meta">@Bean</span></span><br><span class="line">       <span class="keyword">public</span> Bean1 <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@ToString</span></span><br><span class="line">   <span class="meta">@NoArgsConstructor</span></span><br><span class="line">   <span class="meta">@AllArgsConstructor</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">       <span class="keyword">private</span> String name;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 模拟第三方配置类</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguration2</span> &#123;</span><br><span class="line">       <span class="meta">@Bean</span></span><br><span class="line">       <span class="keyword">public</span> Bean2 <span class="title function_">bean2</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean2</span>();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>AutoConfiguration1</code> 和 <code>AutoConfiguration2</code> 用来模拟第三方配置类，注意它们并没有被 <code>@Configuration</code> 注解标记，因此在未进行其他操作时，不会被添加到 Spring 容器中。</p>
<p>然后编写自己的配置类，使用 <code>@Import</code> 注解将第三方配置类添加到 Spring 容器中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//bean1和bean2可以通过@Import注解注入</span></span><br><span class="line"><span class="meta">@Import(&#123;AutoConfiguration1.class,AutoConfiguration2.class&#125;)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">    context.registerBean(<span class="string">&quot;config&quot;</span>,Config.class);</span><br><span class="line">    context.registerBean(ConfigurationClassPostProcessor.class);</span><br><span class="line"></span><br><span class="line">    context.refresh();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String beanDefinitionName : context.getBeanDefinitionNames()) &#123;</span><br><span class="line">        System.out.println(beanDefinitionName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">myAutoConfiguration</span><br><span class="line">org.springframework.context.annotation.ConfigurationClassPostProcessor</span><br><span class="line">org.springframework.boot.A41自动装配.A41$AutoConfiguration1</span><br><span class="line">bean1</span><br><span class="line">org.springframework.boot.A41自动装配.A41$AutoConfiguration2</span><br><span class="line">bean2</span><br></pre></td></tr></table></figure>

<h4 id="Improt-的-ImportSelector"><a href="#Improt-的-ImportSelector" class="headerlink" title="@Improt 的 ImportSelector"></a>@Improt 的 ImportSelector</h4><p>如果有多个第三方配置类，难不成到一个个地导入？</p>
<p>点击进入 <code>@Import</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726192002777-7d7b0023-ec46-446e-9ebe-87b291e0ea2b.png"></p>
<p>可以使用 <code>ImportSelector</code>,获取需要自动装配的 Bean 的全限定类名数组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//bean1和bean2可以通过@Import注解注入</span></span><br><span class="line"><span class="comment">//@Import(&#123;AutoConfiguration1.class,AutoConfiguration2.class&#125;)</span></span><br><span class="line"><span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="comment">//将类名写死在代码里</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">            AutoConfiguration1.class.getName(),AutoConfiguration2.class.getName()</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 selectImports() 方法返回的全限定类名可以从文件中读取，就更方便了。</p>
<p>在当前项目的类路径下创建 <code>META-INF/spring.factories</code> 文件，约定一个 key，对应的 value 即为需要指定装配的 Bean：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内部类作为 key 时，最后以 $ 符号分割</span></span><br><span class="line"><span class="comment"># 每行的结尾用\表示和下一行 的内容 拼接为同一行</span></span><br><span class="line"><span class="attr">org.springframework.boot.A41自动装配.A41$MyImportSelector</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.A41自动装配.A41.AutoConfiguration1,\</span></span><br><span class="line"><span class="string">org.springframework.boot.A41自动装配.A41.AutoConfiguration2</span></span><br></pre></td></tr></table></figure>

<p>修改 <code>ImportSelector</code> 的实现类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">            <span class="comment">//将类名写死在代码里</span></span><br><span class="line"><span class="comment">//            return new String[]&#123;AutoConfiguration1.class.getName(),AutoConfiguration2.class.getName()&#125;;</span></span><br><span class="line">            List&lt;String&gt; names = SpringFactoriesLoader.loadFactoryNames(</span><br><span class="line">                MyImportSelector.class, <span class="literal">null</span></span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> names.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行 main() 方法后，控制台打印出同样的结果。</p>
<p><code>SpringFactoriesLoader.loadFactoryNames() </code> 不仅只扫描当前项目类型路径下</p>
<p>的 <code>META-INF/spring.factories</code> 文件，</p>
<p>而是会扫描包括 Jar 包里类路径下的 <code>META-INF/spring.factories</code> 文件。</p>
<p>针对 SpringBoot 来说,自动装配的 Bean 使用以下语句加载:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpringFactoriesLoader.loadFactoryNames(EnableAutoConfiguration.class, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h3 id="SpringBoot2-7-及其以后版本的自动装配"><a href="#SpringBoot2-7-及其以后版本的自动装配" class="headerlink" title="SpringBoot2.7 及其以后版本的自动装配"></a>SpringBoot2.7 及其以后版本的自动装配</h3><p>在 SpringBoot2.7 及其以后版本,SpringBoot 不在读取 <code>META-INF/spring.factories</code>文件中的 key</p>
<p>为 <code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>的 values 来实现自动装配.</p>
<p>为了更贴合 SPI 机制,SpringBoot 将读取 <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>文件中的内容,</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726219690754-f4ccd77b-22c7-4e85-85fc-9645c20154c8.png"></p>
<p>该文件每一行都表示需要自动装配的 Bean 的全限定类名,可以使用 <code>#</code>作为注释,其加载方式使用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImportCandidates.load(AutoConfiguration.class, getBeanClassLoader());</span><br></pre></td></tr></table></figure>

<p>其中 <code>AutoConfiguration</code>是一个注解,全限定类名为 <code>&lt;font style=&quot;background-color:rgba(255, 255, 255, 0);&quot;&gt;org.springframework.boot.autoconfigure.AutoConfiguration&lt;/font&gt;</code>   </p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726220034951-613620d6-1b3c-45d0-9642-2bdf17363b35.png"></p>
<p>也就是说可以自定义注解,创建自定义 <code>META-INF/spring/full-qualified-annotation-name.imports</code>文件,</p>
<p>在文件里声明需要自动装配的类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dai.dawang.a41;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: MyAutoConfiguration</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAutoConfiguration &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A41</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean3</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 META-INF&#x2F;spring&#x2F;indi.mofan.a41.MyAutoConfiguration.imports 文件：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dai.dawang.a41.A41$Bean3</span></span><br></pre></td></tr></table></figure>

<p>修改 selectImports() 方法实现逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本项目配置类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//bean1和bean2可以通过两种方式注入</span></span><br><span class="line"><span class="comment">//方式一 @Import注解注入</span></span><br><span class="line"><span class="comment">//@Import(&#123;AutoConfiguration1.class,AutoConfiguration2.class&#125;)</span></span><br><span class="line"><span class="comment">//方式二 通过实现ImportSelector接口,MyImportSelector实现ImportSelector</span></span><br><span class="line"><span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Bean1 <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>(<span class="string">&quot;本项目&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="comment">//将类名写死在代码里</span></span><br><span class="line">        <span class="comment">//            return new String[]&#123;AutoConfiguration1.class.getName(),AutoConfiguration2.class.getName()&#125;;</span></span><br><span class="line">        List&lt;String&gt; names = SpringFactoriesLoader.loadFactoryNames(MyImportSelector.class, <span class="literal">null</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">        SpringFactoriesLoader.loadFactoryNames(EnableAutoConfiguration.class, <span class="literal">null</span>).stream().forEach(System.out::println);</span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//读取新自动装配文件</span></span><br><span class="line">        <span class="type">ImportCandidates</span> <span class="variable">load</span> <span class="operator">=</span> ImportCandidates.load(MyAutoConfiguration.class, MyAutoConfiguration.class.getClassLoader());</span><br><span class="line">        <span class="comment">//这里的namse是不可变的,</span></span><br><span class="line">        <span class="comment">//SpringFactoriesLoader.loadFactoryNames源码里有 return Collections.unmodifiableMap(result);</span></span><br><span class="line">        <span class="comment">//返回一个不可变的集合 ,所以需要转换为可变数组</span></span><br><span class="line">        names = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(names);</span><br><span class="line">        load.forEach(names::add);</span><br><span class="line">        <span class="keyword">return</span> names.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行 main() 方法后，Spring 容器中的 Bean 多了 一个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dai.dawang.a41.A41$Bean3</span><br></pre></td></tr></table></figure>



<h4 id="补充-Import-的-Improt-的-ImportBeanDefinitionRegistrar"><a href="#补充-Import-的-Improt-的-ImportBeanDefinitionRegistrar" class="headerlink" title="补充 @Import 的@Improt 的 ImportBeanDefinitionRegistrar"></a>补充 @Import 的@Improt 的 ImportBeanDefinitionRegistrar</h4><p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726293250257-08010284-f90b-4821-acc2-bdf2991503e0.png"></p>
<p>我们刚刚了解的 <code>@Import</code> 的 <code>ImportSelector</code> 属性和 实现类 <code>&lt;font style=&quot;background-color:rgba(255, 255, 255, 0);&quot;&gt;DeferredImportSelector&lt;/font&gt;</code></p>
<h3 id="定义了冲突的-Bean"><a href="#定义了冲突的-Bean" class="headerlink" title="定义了冲突的 Bean"></a>定义了冲突的 Bean</h3><p>第三方装配了 Bean1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟第三方配置类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguration1</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Bean1 <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>(<span class="string">&quot;第三方&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户又自行定义了 Bean1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 本项目配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//bean1和bean2可以通过两种方式注入</span></span><br><span class="line"><span class="comment">//方式一 @Import注解注入</span></span><br><span class="line"><span class="comment">//@Import(&#123;AutoConfiguration1.class,AutoConfiguration2.class&#125;)</span></span><br><span class="line"><span class="comment">//方式二 通过实现ImportSelector接口</span></span><br><span class="line"><span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Bean1 <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>(<span class="string">&quot;本项目&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改测试的 main() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        context.registerBean(<span class="string">&quot;config&quot;</span>, Config.class);</span><br><span class="line">        context.registerBean(ConfigurationClassPostProcessor.class);</span><br><span class="line">        <span class="comment">//将默认 允许覆盖 设置为 不允许</span></span><br><span class="line"><span class="comment">//    context.getDefaultListableBeanFactory().setAllowBeanDefinitionOverriding(false);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//第三方 和 本地 配置同时注册bean1</span></span><br><span class="line">        System.out.println(context.getBean(<span class="string">&quot;bean1&quot;</span>, Bean1.class));</span><br><span class="line">        <span class="comment">//发现打印A41.Bean1(name=本项目)</span></span><br><span class="line">        <span class="comment">//是因为:在加载myAutoConfiguration类时, @Import优先于 @Bean,所以先加载第三方才加载本地,后者覆盖前者，使得用户自定义的 Bean 生效</span></span><br><span class="line">        <span class="comment">//在DefaultListableBeanFactory里 private boolean allowBeanDefinitionOverriding = true; 表示默认 允许覆盖</span></span><br><span class="line"></span><br><span class="line">        Arrays.stream(context.getBeanDefinitionNames()).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A41.Bean1(name=本项目)</span><br></pre></td></tr></table></figure>

<p>用户自行定义的 Bean 生效了，这是因为：<code>@Import</code> 导入的 Bean 先于配置类中 <code>@Bean</code> 定义的 Bean 执行，<font style="background-color:#117CEE;">后者覆盖前者</font>，使得用户自定义的 Bean 生效。</p>
<p>但在 SpringBoot 中不是这样的，当后续添加的 Bean 想覆盖先前添加的 Bean，会出现错误。模拟 SpringBoot 的设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">    <span class="comment">// 默认是 true，SpringBoot 修改为 false，使得无法进行覆盖</span></span><br><span class="line">    context.getDefaultListableBeanFactory().setAllowBeanDefinitionOverriding(<span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> org.springframework.beans.factory.support.BeanDefinitionOverrideException: Invalid bean definition with name <span class="string">&#x27;bean1&#x27;</span> defined in dai.dawang.a41.A41$Config: Cannot register bean definition [Root bean: class [<span class="literal">null</span>]; scope=; <span class="keyword">abstract</span>=<span class="literal">false</span>; lazyInit=<span class="literal">null</span>; autowireMode=<span class="number">3</span>; dependencyCheck=<span class="number">0</span>; autowireCandidate=<span class="literal">true</span>; primary=<span class="literal">false</span>; factoryBeanName=config; factoryMethodName=bean1; initMethodNames=<span class="literal">null</span>; destroyMethodNames=[(inferred)]; defined in dai.dawang.a41.A41$Config] <span class="keyword">for</span> bean <span class="string">&#x27;bean1&#x27;</span> since there is already [Root bean: class [<span class="literal">null</span>]; scope=; <span class="keyword">abstract</span>=<span class="literal">false</span>; lazyInit=<span class="literal">null</span>; autowireMode=<span class="number">3</span>; dependencyCheck=<span class="number">0</span>; autowireCandidate=<span class="literal">true</span>; primary=<span class="literal">false</span>; factoryBeanName=dai.dawang.a41.A41$AutoConfiguration1; factoryMethodName=bean1; initMethodNames=<span class="literal">null</span>; destroyMethodNames=[(inferred)]; defined in <span class="keyword">class</span> <span class="title class_">path</span> resource [dai/dawang/a41/A41$AutoConfiguration1.class]] bound.</span><br></pre></td></tr></table></figure>

<p>那这样是合理的吗？</p>
<p>显然不是。比如 SpringBoot 默认的数据连接池是 Hikari，如果用户想换成 Druid，岂不是做不到？</p>
<p>实际情况下是能做到的，这又是怎么做到的呢？</p>
<p>首先需要使用户的配置类中定义的 Bean 先于 <code>@Import</code> 导入的 Bean 添加到 Spring 容器中，</p>
<p>只需将选择器 <code>MyImportSelector</code> 实现的 <code>ImportSelector</code> 接口更换成其子接口 <code>DeferredImportSelector</code> 即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> org.springframework.beans.factory.support.BeanDefinitionOverrideException: Invalid bean definition with name <span class="string">&#x27;bean1&#x27;</span> defined in <span class="keyword">class</span> <span class="title class_">path</span> resource [dai/dawang/a41/A41$AutoConfiguration1.class]: Cannot register bean definition [Root bean: class [<span class="literal">null</span>]; scope=; <span class="keyword">abstract</span>=<span class="literal">false</span>; lazyInit=<span class="literal">null</span>; autowireMode=<span class="number">3</span>; dependencyCheck=<span class="number">0</span>; autowireCandidate=<span class="literal">true</span>; primary=<span class="literal">false</span>; factoryBeanName=dai.dawang.a41.A41$AutoConfiguration1; factoryMethodName=bean1; initMethodNames=<span class="literal">null</span>; destroyMethodNames=[(inferred)]; defined in <span class="keyword">class</span> <span class="title class_">path</span> resource [dai/dawang/a41/A41$AutoConfiguration1.class]] <span class="keyword">for</span> bean <span class="string">&#x27;bean1&#x27;</span> since there is already [Root bean: class [<span class="literal">null</span>]; scope=; <span class="keyword">abstract</span>=<span class="literal">false</span>; lazyInit=<span class="literal">null</span>; autowireMode=<span class="number">3</span>; dependencyCheck=<span class="number">0</span>; autowireCandidate=<span class="literal">true</span>; primary=<span class="literal">false</span>; factoryBeanName=config; factoryMethodName=bean1; initMethodNames=<span class="literal">null</span>; destroyMethodNames=[(inferred)]; defined in dai.dawang.a41.A41$Config] bound.</span><br></pre></td></tr></table></figure>

<p>尽管还是出现了异常，但异常信息中显示的是在配置类定义的 Bean 已存在，第三方装配的 Bean 无法再添加，这表明 Bean 的添加顺序修改成功。</p>
<p>最后在第三方定义的 Bean 上添加 <code>@ConditionalOnMissingBean</code> 注解，表示容器中存在同名的 Bean 时忽略该 Bean 的添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟第三方配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguration1</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span><span class="comment">//仅当BeanFactory中没有满足指定要求的bean时才匹配的条件</span></span><br><span class="line">    <span class="keyword">public</span> Bean1 <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>(<span class="string">&quot;第三方&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A41.Bean1(name=本项目)</span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><p><font style="background-color:rgba(255, 255, 255, 0);">那么 </font><code>&lt;font style=&quot;background-color:rgba(255, 255, 255, 0);&quot;&gt;ImportBeanDefinitionRegistrar&lt;/font&gt;</code><font style="background-color:rgba(255, 255, 255, 0);">属性如何使用呢?</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ImportBeanDefinitionRegistrar属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: Import注解如何使用 ImportBeanDefinitionRegistrar属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>属性 &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();</span></span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">// AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span></span><br><span class="line"></span><br><span class="line">        context.registerBean(ConfigurationClassPostProcessor.class);</span><br><span class="line">        context.registerBean(<span class="string">&quot;config&quot;</span>, Config.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        Arrays.stream(context.getBeanDefinitionNames()).forEach(System.out::println);</span><br><span class="line">        System.out.println(context.getBean(User.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Import(&#123;MyImportBeanDefinitionRegistrar.class&#125;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">            <span class="comment">// 构建 BeanDefinition</span></span><br><span class="line">            <span class="type">AbstractBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(User.class)</span><br><span class="line">                    .addPropertyValue(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;daidawang&quot;</span>)</span><br><span class="line">                    .addPropertyValue(<span class="string">&quot;age&quot;</span>, <span class="number">24</span>)</span><br><span class="line">                    .getBeanDefinition();</span><br><span class="line">            <span class="comment">// 注册构建好的 BeanDefinition</span></span><br><span class="line">            registry.registerBeanDefinition(<span class="string">&quot;user&quot;</span>, beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="meta">@ToString</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.ConfigurationClassPostProcessor</span><br><span class="line">config</span><br><span class="line">user</span><br><span class="line">ImportBeanDefinitionRegistrar属性.User(name=daidawng, age=<span class="number">24</span>)</span><br></pre></td></tr></table></figure>

<h2 id="41-2-Aop-自动配置"><a href="#41-2-Aop-自动配置" class="headerlink" title="41.2 Aop 自动配置"></a>41.2 Aop 自动配置</h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><p><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;AopAutoConfiguration&lt;/font&gt;</code>类完成 AOP 自动装配, </p>
<p><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;AopAutoConfiguration&lt;/font&gt;</code>类通过<code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;@Conditionalxxx&lt;/font&gt;</code>注解的判断后,</p>
<p>都会往 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;BeanDefinition注册表:  BeanDefinitionRegistry &lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>里添加<font style="color:#DF2A3F;"> </font><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;AnnotationAwareAspectJAutoProxyCreator&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>的 Bean 完成AOP 自动装配。</p>
<p>确保当前模块导入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: AopAuto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: aop自动配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AopAuto</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">//在给定的注册表中注册所有相关的注释后处理器。</span></span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(</span><br><span class="line">                context.getDefaultListableBeanFactory()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        context.registerBean(Config.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        Arrays.stream(context.getBeanDefinitionNames()).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;AopAutoConfiguration.class.getName()&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">dai.dawang.a41.aop自动配置.AopAuto$Config</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration$AspectJAutoProxyingConfiguration$CglibAutoProxyConfiguration</span><br><span class="line">org.springframework.aop.config.internalAutoProxyCreator</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration$AspectJAutoProxyingConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration</span><br></pre></td></tr></table></figure>

<p>打印内容以 ai.dawang.a41.aop自动配置.AopAuto$Config </p>
<p>为分割线，上方是添加的一些后置处理器 ,下方是 AOP 自动装配添加的 Bean</p>
<p>点击进入 <code>AopAutoConfiguration</code> </p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726288237993-3b23504b-9c9f-4573-9ae5-255b783e62a4.png"></p>
<p>类上添加注解 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;@ConditionOnProperty&lt;/font&gt;</code>的配置信息: 如果文件中存在 前缀 为 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;spring.aop&lt;/font&gt;</code> ,名称 为 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;auto&lt;/font&gt;</code>的 key,且对应的 value 是 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;true&lt;/font&gt;</code>时,配置类 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;AopAutoConfiguration&lt;/font&gt;</code>生效, 属性 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;matchIfMissing&lt;/font&gt;</code>表示:如果配置文件中未显式配置,该配置类依然生效。</p>
<p>不使用配置文件,使用 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;StandardEnvironment&lt;/font&gt;</code>指定 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;spring.aop.auto&lt;/font&gt;</code>的值为 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;false&lt;/font&gt;</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">       <span class="comment">//ApplicationEnvironment是StandardEnvironment的子类</span></span><br><span class="line">       <span class="type">StandardEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">       <span class="comment">//添加一个 简单命令行属性资源, 主要参数是main方法的参数args ,及选项参数需要以--开头</span></span><br><span class="line">       <span class="comment">//AopAutoConfiguration类上注解@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><br><span class="line">       environment.getPropertySources().addLast(<span class="keyword">new</span> <span class="title class_">SimpleCommandLinePropertySource</span>(<span class="string">&quot;--spring.aop.auto=false&quot;</span>));</span><br><span class="line">       context.setEnvironment(environment);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//--snip--</span></span><br><span class="line">&#125;&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">dai.dawang.a41.aop自动配置.AopAuto$Config</span><br></pre></td></tr></table></figure>

<p>如果 <code>spring.aop.auto</code> 的值是 <code>true</code>，又会成功添加上 AOP 自动装配的 Bean。</p>
<p>再看 <code>AopAutoConfiguration</code>的内部类;</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726289352925-362f6ab5-150a-4f35-abdf-452d5692ba10.png"></p>
<p>其内部存在两个类：<code>AspectJAutoProxyingConfiguration</code> 和 <code>ClassProxyingConfiguration</code>。</p>
<p>使用了 <code>@ConditionalOnClass</code> 注解判断 Advice.class 存在时，<code>AspectJAutoProxyingConfiguration</code> 生效；</p>
<p>使用 <code>@ConditionalOnMissingClass</code> 注解判断 org.aspectj.weaver.Advice 不存在时，<code>ClassProxyingConfiguration</code> 生效。</p>
<p>由于先前导入了 <code>spring-boot-starter-aop</code> 依赖，Advice.class 是存在的，<code>AspectJAutoProxyingConfiguration</code> 将生效。</p>
<p><code>AspectJAutoProxyingConfiguration</code> 内部又有两个配置类：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726289459223-c570b37d-0e90-430d-b845-9dcd3d86a05e.png"></p>
<p>这两个配置类通过使用 <code>@ConditionalOnProperty</code> 注解判断配置文件中是否存在 <code>spring.aop.proxy-target-class</code> 配置来让对应的配置类生效。</p>
<p>由于并未显式配置，因此 <code>CglibAutoProxyConfiguration</code> 将生效。</p>
<p>无论哪个配置类生效，它们都被 <code>@EnableAspectJAutoProxy</code> 标记，这个注解相当于是添加了些配置的 <code>@Import</code> 注解：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726289542954-b6ecce77-4cd3-4e76-9f97-c758939a9e79.png"></p>
<p>所以 <code>@EnableAspectJAutoProxy</code> 作用是向 Spring 容器中添加 AspectJAutoProxyRegistrar 类型的 Bean。</p>
<p><code>AspectJAutoProxyRegistrar</code> 实现了 <code>ImportBeanDefinitionRegistrar</code> 接口，可以使用编程的方式来注册一些 Bean：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726289752110-5a664e40-7173-4cb5-86ac-4761658b7324.png"></p>
<p><code>AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary()</code> 方法是注册 Bean 的主要逻辑：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726289811029-8cebc3b9-3ffe-4579-a3b9-b79d19e0ba72.png"></p>
<p>最终注册了 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;AnnotationAwareAspectJAutoProxyCreator&lt;/font&gt;</code>。</p>
<p>使用打印的内容 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;org.springframework.aop.config.internalAutoProxyCreator&lt;/font&gt;</code>作为名称，获取 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;AnnotationAwareAspectJAutoProxyCreator&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>类型的 Bean，并查看<code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;proxyTargetClass&lt;/font&gt;</code>属性的值:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">    <span class="comment">//ApplicationEnvironment是StandardEnvironment的子类</span></span><br><span class="line">    <span class="type">StandardEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">    <span class="comment">//添加一个 简单命令行属性资源, 主要参数是main方法的参数args ,及选项参数需要以--开头</span></span><br><span class="line">    <span class="comment">//AopAutoConfiguration类上注解@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><br><span class="line">    environment.getPropertySources().addLast(<span class="keyword">new</span> <span class="title class_">SimpleCommandLinePropertySource</span>(<span class="string">&quot;--spring.aop.auto=true&quot;</span>));</span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在给定的注册表中注册所有相关的注释后处理器。</span></span><br><span class="line">    AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line"></span><br><span class="line">    context.registerBean(Config.class);</span><br><span class="line">    context.refresh();</span><br><span class="line"></span><br><span class="line">    Arrays.stream(context.getBeanDefinitionNames()).forEach(System.out::println);</span><br><span class="line">    System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**，</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@EnableAspectJAutoProxy</span>(proxyTargetClass = true) 的作用是:</span></span><br><span class="line"><span class="comment">     * 根据给定的<span class="doctag">@EnableAspectJ</span> AutoProxy注释，在当前BeanDefinition注册表中适当注册AnnotationAwareAspectJAutoProxyCreator。</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 证明是:</span></span><br><span class="line"><span class="comment">     * 点击进入AopAutoConfiguration，点击进入<span class="doctag">@EnableAspectJAutoProxy</span>(proxyTargetClass = true)</span></span><br><span class="line"><span class="comment">     * 点击进入<span class="doctag">@Import</span>(AspectJAutoProxyRegistrar.class)，</span></span><br><span class="line"><span class="comment">     * 点击进入opConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);</span></span><br><span class="line"><span class="comment">     * 点击进入return registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry, (Object)null);</span></span><br><span class="line"><span class="comment">     * 看到return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);</span></span><br><span class="line"><span class="comment">     * 注意参数AnnotationAwareAspectJAutoProxyCreator类</span></span><br><span class="line"><span class="comment">     * AnnotationAwareAspectJAutoProxyCreator是BeanPostProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">AnnotationAwareAspectJAutoProxyCreator</span> <span class="variable">creator</span> <span class="operator">=</span> context.getBean(</span><br><span class="line">            <span class="string">&quot;org.springframework.aop.config.internalAutoProxyCreator&quot;</span>, AnnotationAwareAspectJAutoProxyCreator.class);</span><br><span class="line">    System.out.println(creator.isProxyTargetClass());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>还记得 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;proxyTargetClass&lt;/font&gt;</code>属性是做什么的吗?</p>
<p>请参考 :  <a target="_blank" rel="noopener" href="https://www.yuque.com/daidawang-jlmiu/tyvtug/mbbgndf2venlqh94">黑马四十九讲AOP</a> 6.3 .spring 根据什么信息选择不同的代理？ 章节</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726290507744-f9c07f25-77ad-48e8-8718-956ddb88cb39.png"></p>
<h2 id="41-3-数据库相关的自动配置"><a href="#41-3-数据库相关的自动配置" class="headerlink" title="41.3 数据库相关的自动配置"></a>41.3 数据库相关的自动配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="DataSource-自动配置"><a href="#DataSource-自动配置" class="headerlink" title="DataSource 自动配置"></a>DataSource 自动配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: DataSourceAuto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 数据库相关的自动配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAuto</span> &#123;</span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">                    <span class="comment">// 数据源自动配置类</span></span><br><span class="line">                    DataSourceAutoConfiguration.class.getName(),</span><br><span class="line">                    <span class="comment">// mybatis自动配置类</span></span><br><span class="line">                    MybatisAutoConfiguration.class.getName(),</span><br><span class="line">                    <span class="comment">// 事务自动配置类(事务回滚,提交)</span></span><br><span class="line">                    DataSourceTransactionManagerAutoConfiguration.class.getName(),</span><br><span class="line">                    <span class="comment">// 事务自动配置类(事务切面,切点,事务控制)</span></span><br><span class="line">                    TransactionAutoConfiguration.class.getName()</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: DataSourceAuto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 数据库相关的自动配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAuto</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        context.registerBean(Config.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">StandardEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">        environment.getPropertySources().addLast(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SimpleCommandLinePropertySource</span>(</span><br><span class="line">                        <span class="string">&quot;--spring.datasource.url=jdbc:mysql://localhost:3306/test&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;--spring.datasource.username=root&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;--spring.datasource.password=root&quot;</span></span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">        context.setEnvironment(environment);</span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line">        HashMap&lt;String, List&lt;String&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String name : context.getBeanDefinitionNames()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">resourceDescription</span> <span class="operator">=</span> context.getBeanDefinition(name).getResourceDescription();</span><br><span class="line">            map.computeIfAbsent(resourceDescription, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(name);</span><br><span class="line"><span class="comment">//            System.out.println(name + &quot; 来源： &quot; + resourceDescription);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map.forEach((k, v) -&gt; System.out.println(<span class="string">&quot;来源 &quot;</span>+k + <span class="string">&quot;= &quot;</span> +<span class="string">&quot;名称 :&quot;</span>+ v));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">来源 <span class="keyword">class</span> <span class="title class_">path</span> resource [org/springframework/boot/autoconfigure/jdbc/DataSourceConfiguration$Hikari.class]= 名称 :[jdbcConnectionDetailsHikariBeanPostProcessor, dataSource]</span><br></pre></td></tr></table></figure>

<p>名叫 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;dataSource&lt;/font&gt;</code>的 Bean 的来源是 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSourceConfiguration&lt;/font&gt;</code>,而不是 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSourceAutoConfiguration&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>呢?</p>
<p>进入 <code>DataSourceAutoConfiguration</code>源码,<img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726630855994-2654aafb-4a53-4296-a7ce-3b36889775f4.png"></p>
<p>内部类 <code>EmbeddedDatabaseConfiguration</code> 和 <code>PooledDataSourceConfiguration</code> 都被 <code>@Conditional</code>注解标记, </p>
<p>当项目支持内嵌数据源时,  <code>EmbeddedDatabaseConfiguration</code> 生效</p>
<p>当项目支持数据库连接池的数据源时,<code>PooledDataSourceConfiguration</code>生效</p>
<p>SpringBoot 默认数据库连接池是 <code>Hikari</code>,</p>
<p>所以<code>PooledDataSourceConfiguration</code>生效,</p>
<p>通过 <code>@Import</code>导入一系列 Bean  都是 <code>DataSourceConfiguration</code>的内部类,</p>
<p>所以 <code>DataSource</code>的 Bean 来源是 <code>DataSourceConfiguration</code>。</p>
<p>由于导入了 <code>mybatis-spring-boot-starter</code>，其内部依赖 <code>mybatis-spring-boot-jdbc</code>，而它又依赖了 <code>HikariCP</code>，因此最终数据库连接池 <code>Hikari</code> 生效：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726631583391-26266e2f-0a63-407f-a730-65bb3b32049e.png"></p>
<p>在 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;Hikari#dataSource()&lt;/font&gt;</code> 方法中，接受一个 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSourceProperties&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>类型的参数，这要求 Spring 容器中存在 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSourceProperties&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>类型的 Bean。</p>
<p>在最初的 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSourceAutoConfiguration&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>自动配置类上有个 <code>@&lt;font style=&quot;color:#DF2A3F;&quot;&gt;EnableConfigurationProperties&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>注解，它将 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSourceProperties&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>添加到容器中：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726631691140-5d6c6aa0-3904-4a7c-b72c-1b550695537d.png"></p>
<p>在 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSourceProperties&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>中会绑定配置文件中以 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;spring.datasource&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>为前缀的配置：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726631726158-e4a5257f-c926-4e48-8948-e8c17ee63076.png"></p>
<p>获取 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSourceProperties&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>类型的 Bean，并打印其 url、username 和 password：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        context.registerBean(Config.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">StandardEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">        environment.getPropertySources().addLast(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SimpleCommandLinePropertySource</span>(</span><br><span class="line">                        <span class="string">&quot;--spring.datasource.url=jdbc:mysql://localhost:3306/test&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;--spring.datasource.username=root&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;--spring.datasource.password=root&quot;</span></span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">        context.setEnvironment(environment);</span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line">        HashMap&lt;String, List&lt;String&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String name : context.getBeanDefinitionNames()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">resourceDescription</span> <span class="operator">=</span> context.getBeanDefinition(name).getResourceDescription();</span><br><span class="line">            map.computeIfAbsent(resourceDescription, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(name);</span><br><span class="line"><span class="comment">//            System.out.println(name + &quot; 来源： &quot; + resourceDescription);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//map.forEach((k, v) -&gt; System.out.println(&quot;来源 &quot;+k + &quot;= &quot; +&quot;名称 :&quot;+ v));</span></span><br><span class="line"></span><br><span class="line">        <span class="type">DataSourceProperties</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(DataSourceProperties.class);</span><br><span class="line">        System.out.println(bean.getUrl());</span><br><span class="line">        System.out.println(bean.getUsername());</span><br><span class="line">        System.out.println(bean.getPassword());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="comment">//localhost:3306/test</span></span><br><span class="line">root</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h2 id="Mybatis-自动配置"><a href="#Mybatis-自动配置" class="headerlink" title="Mybatis 自动配置"></a>Mybatis 自动配置</h2><p>进入 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;MybatisAutoConfiguration&lt;/font&gt;</code>:</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726633231976-e577db94-4d8e-40d7-bf73-b0bcf74c232a.png"></p>
<h3 id="MybatisAutoConfiguration-的条件注解"><a href="#MybatisAutoConfiguration-的条件注解" class="headerlink" title="MybatisAutoConfiguration 的条件注解"></a>MybatisAutoConfiguration 的条件注解</h3><p> <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;MybatisAutoConfiguration&lt;/font&gt;</code> 生效的条件有两个：</p>
<ul>
<li>类路径下有<font style="color:#bcbec4;background-color:#1e1f22;">SqlSessionFactory, SqlSessionFactoryBean</font></li>
<li>Spring 容器中 有且仅有 一个 <code>DataSource</code>的 bean添加了 ]</li>
</ul>
<p>同时添加了 <code>MybatisProperties</code> 类型的 Bean 到 Spring 容器中，并与配置文件中以 mybatis 为前缀的信息绑定。</p>
<p><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;@AutoConfigureAfter&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>注解指定了当前自动配置类在 <code>DataSourceAutoConfiguration</code> 和 <code>MybatisLanguageDriverAutoConfiguration</code> 两个自动配置类解析完成之后再解析。</p>
<hr>
<p>接下来是 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;sqlSessionFactory()&lt;/font&gt;</code>方法:</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726632554627-46e0dd6b-9a1e-4d11-8679-1822cf8eba1e.png"></p>
<p>依赖 Spring 容器的	<code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;DataSource&lt;/font&gt;</code>,当容器中不存在 <code>SqlSessionFactory</code> 时，将其添加到 Spring 容器中。</p>
<hr>
<h3 id="SqlSessionTemplate-的作用"><a href="#SqlSessionTemplate-的作用" class="headerlink" title="SqlSessionTemplate 的作用"></a>SqlSessionTemplate 的作用</h3><p>然后是<font style="color:#DF2A3F;"> </font><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;sqlSessionTemplate()&lt;/font&gt; </code> 方法，它与添加 <code>SqlSessionFactory</code> 到 Spring 容器的逻辑一样：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726632654337-b421433a-d488-4078-b770-2fa0b1832440.png"></p>
<p><code>SqlSessionTemplate</code>也是 <code>SqlSession</code>的实现,它提供与当前线程绑定的 <code>SqlSession</code>。</p>
<p>多个方法调用,如果它们来自同一个线程,那么获取的 <code>SqlSession</code>对象是同一个。</p>
<p>这也是 <code>SqlSessionTemplate</code>与 <code>DefultSqlSession</code>的区别。</p>
<p>在 Mybatis 中,<code>MapperFactoryBean</code>将接口转为对象,核心是 <code>getObjext()</code>方法,方法使用的是 <code>SqlSessionTemplate</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726633003152-8183f69b-bf4c-4e57-9150-ae82fce0b114.png"></p>
<hr>
<h3 id="内部类MapperScannerRegistrarNotFoundConfiguration"><a href="#内部类MapperScannerRegistrarNotFoundConfiguration" class="headerlink" title="内部类MapperScannerRegistrarNotFoundConfiguration"></a>内部类MapperScannerRegistrarNotFoundConfiguration</h3><p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726633456617-ad9f4fea-b7fe-41b2-9455-03054579e63f.png"></p>
<p> <code>@ConditionalOnMissingBean</code> 判断 Spring 容器中缺失 <code>MapperFactoryBean</code> 和 <code>MapperScannerConfigurer</code> 时，该配置类生效。</p>
<p>生效时利用 <code>@Import</code> 导入 <code>AutoConfiguredMapperScannerRegistrar</code>：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726634430103-b8190304-473b-46bc-93e5-98c2017587c0.png"></p>
<p><code>AutoConfiguredMapperScannerRegistrar</code> 实现了 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;ImportBeanDefinitionRegistrar&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>接口，允许通过编程的方式加 Bean 添加到 Spring 容器中(详细请 向上查找 : <strong>41.1 补充 @Import 的@Improt 的 ImportBeanDefinitionRegistrar</strong>)，而这里是去扫描 Mapper 接口，将其转换为对象添加到 Spring 容器中。</p>
<p>在 main 方法所在类的包路径下创建 mapper 包,并创建 2 个带@Mapper 一个不带共计三个类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Mapper1</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Mapper2</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Mapper3</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行 main() 方法，查看 Mapper1 和 Mapper2 是否被添加到 Spring 容器中。</p>
<p>结果是否定的。因为 <strong>没有设置要扫描的包路径</strong> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> DataSourceAuto.class.getPackageName();</span><br><span class="line">    System.out.println(<span class="string">&quot;当前包名: &quot;</span> + packageName);</span><br><span class="line">    AutoConfigurationPackages.register(context.getDefaultListableBeanFactory(),</span><br><span class="line">            packageName);</span><br><span class="line"></span><br><span class="line">    context.refresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当前包名: dai.dawang.a41.数据库相关的自动配置</span><br><span class="line">来源 file [D:\workspace\advanced-spring\boot\target\classes\dai\dawang\a41\数据库相关的自动配置\mapper\Mapper1.class]= 名称 :[mapper1]</span><br><span class="line">来源 file [D:\workspace\advanced-spring\boot\target\classes\dai\dawang\a41\数据库相关的自动配置\mapper\Mapper2.class]= 名称 :[mapper2]</span><br></pre></td></tr></table></figure>

<h4 id="MapperScan-注解与-MybatisAutoConfiguration-在功能区别"><a href="#MapperScan-注解与-MybatisAutoConfiguration-在功能区别" class="headerlink" title="@MapperScan 注解与 MybatisAutoConfiguration 在功能区别"></a>@MapperScan 注解与 MybatisAutoConfiguration 在功能区别</h4><ul>
<li><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;@MapeerScan&lt;/font&gt;</code> 可以指定扫描路径, 未指定时会把引导类范围内的所有接口当做 <code>Mapper</code> 接口；</li>
<li><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;MybatisAutoConfiguration&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>关注所有被 <code>@Mapper</code> 注解标记的类并忽略 未被标记的接口。</li>
</ul>
<h2 id="事务自动配置"><a href="#事务自动配置" class="headerlink" title="事务自动配置"></a>事务自动配置</h2><p>事务自动配置与  <code>DataSourceTransactionManagerAutoConfiguration</code>、<code>TransactionAutoConfiguration</code> 有关。</p>
<p><code>DataSourceTransactionManagerAutoConfiguration</code> 配置了 <code>DataSourceTransactionManager</code> 用来执行事务的提交、回滚操作。</p>
<p><code>TransactionAutoConfiguration</code> 在功能上对标 <code>@EnableTransactionManagement</code>，包含以下三个 Bean：</p>
<ul>
<li><code>BeanFactoryTransactionAttributeSourceAdvisor</code>：事务切面类，包含通知和切点</li>
<li><code>TransactionInterceptor</code>：事务通知类，由它在目标方法调用前后加入事务操作</li>
<li><code>AnnotationTransactionAttributeSource</code>：解析 @Transactional 及事务属性，还包含了切点功能</li>
</ul>
<p>如果自定义了 DataSourceTransactionManager 或是在引导类加了 @EnableTransactionManagement，则以自定义为准。</p>
<h2 id="MVC-自动配置"><a href="#MVC-自动配置" class="headerlink" title="MVC 自动配置"></a>MVC 自动配置</h2><p>MVC 自动配置用到 4 个类:</p>
<ul>
<li>配置内嵌 Tomcat 服务器工厂:ServletWebServerFactoryAutoConfiguration</li>
<li>配置 DispatchSerlet:DispatcherServletAutoConfiguration</li>
<li>配置 WebMVC 各种组件:WebMvcAutoConfiguration</li>
<li>配置 MVC 的错误处理: ErrorMvcAutoConfiguration</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcAuto</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AnnotationConfigServletWebServerApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigServletWebServerApplicationContext</span>();</span><br><span class="line">        context.registerBean(Config.class);</span><br><span class="line">        context.refresh();</span><br><span class="line">        <span class="keyword">for</span> (String name : context.getBeanDefinitionNames()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> context.getBeanDefinition(name).getResourceDescription();</span><br><span class="line">            <span class="keyword">if</span> (source != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(name + <span class="string">&quot; 来源:&quot;</span> + source);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">                    <span class="comment">// 配置内嵌 Tomcat 服务器工厂</span></span><br><span class="line">                    ServletWebServerFactoryAutoConfiguration.class.getName(),</span><br><span class="line">                    <span class="comment">// 配置 DispatcherServlet</span></span><br><span class="line">                    DispatcherServletAutoConfiguration.class.getName(),</span><br><span class="line">                    <span class="comment">// 配置 WebMVC 各种组件</span></span><br><span class="line">                    WebMvcAutoConfiguration.class.getName(),</span><br><span class="line">                    <span class="comment">// 配置 MVC 的错误处理</span></span><br><span class="line">                    ErrorMvcAutoConfiguration.class.getName()</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>tomcatServletWebServerFactory: 来源ServletWebServerFactoryConfiguration$EmbeddedTomcat </p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726654601922-55f85af4-5614-4fe1-ada8-b662a7975479.png"></p>
<hr>
<p>来源 class path resource [org&#x2F;springframework&#x2F;boot&#x2F;autoconfigure&#x2F;web&#x2F;servlet&#x2F;ServletWebServerFactoryAutoConfiguration.class]&#x3D; 名称 :[servletWebServerFactoryCustomizer, tomcatServletWebServerFactoryCustomizer]</p>
<p>分别表示 web 的扩展 与 tomcat 的扩展</p>
<hr>
<p>来源 class path resource [org&#x2F;springframework&#x2F;boot&#x2F;autoconfigure&#x2F;web&#x2F;servlet&#x2F;DispatcherServletAutoConfiguration$DispatcherServletConfiguration.class]&#x3D; 名称 :[dispatcherServlet]</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726654866530-9e98276e-fb90-4d8a-91ef-49f73a53b39b.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726654903537-cf0472f3-c3e7-4138-81b4-284845432f8d.png"></p>
<hr>
<p>来源 null &#x3D; 名称 :[org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration$DispatcherServletRegistrationConfiguration]</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/23216672/1726655087738-cae4ba73-eed7-4944-afe3-a820a386a512.png"></p>
<h2 id="自定义自动配置类"><a href="#自定义自动配置类" class="headerlink" title="自定义自动配置类"></a>自定义自动配置类</h2><p>在 SpringBoot 自动配置自定义组件分为两步:</p>
<ol>
<li>在类路径下自定义 <code>META-INF/spring.factories</code>文件,以 <code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code> 为 key,设置需要自动装配的自定义组件的全限定类名为 value</li>
<li>编写配置类,添加 <code>@EnableAutoConfiguration</code>注解</li>
</ol>
<h3 id="SpringBoot2-7-0-及其以后版本"><a href="#SpringBoot2-7-0-及其以后版本" class="headerlink" title="SpringBoot2.7.0 及其以后版本"></a>SpringBoot2.7.0 及其以后版本</h3><p>在类路径下自定义 <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>文件,文件 每一行 表示需要自动装配的类的全限定类名,所以不要随便换行</p>
<h1 id="42-条件装配底层"><a href="#42-条件装配底层" class="headerlink" title="42.条件装配底层"></a>42.条件装配底层</h1><h2 id="42-1-Conditional"><a href="#42-1-Conditional" class="headerlink" title="42.1@Conditional"></a>42.1@Conditional</h2><p>在 SpringBoot 的自动配置中,经常看到 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;@Conditional&lt;/font&gt;</code>注解,该注解可以按条件加载配置类</p>
<p><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;@Conditional&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>注解是通过指定的 Class 实现 <code>Condition</code>接口 进行判断</p>
<p>现在判断类路径下是否存在 <code>org.springframework.boot.autoconfigure.jdbc.DataSourceProperties</code> 来加载不同的配置类, 当存在 <code>DataSourceProperties</code> 时加载 <code>AutoConfiguration1</code>,反之加载 <code>AutoConfiguration2</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dai.dawang.a42条件装配底层;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dai.dawang.a41.自动配置原理.A41;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ClassUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: a42</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 条件装配</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">a42</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        context.registerBean(ConfigurationClassPostProcessor.class);</span><br><span class="line">        context.registerBean(Config.class);</span><br><span class="line"><span class="comment">/*        context.registerBean(AutoConfiguration1.class);</span></span><br><span class="line"><span class="comment">        context.registerBean(AutoConfiguration2.class);*/</span></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        Arrays.stream(context.getBeanDefinitionNames()).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//    @Import(&#123;AutoConfiguration1.class, AutoConfiguration2.class&#125;)</span></span><br><span class="line">    <span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;AutoConfiguration1.class.getName(), AutoConfiguration2.class.getName()&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyCondition1</span> <span class="keyword">implements</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ClassUtils.isPresent(<span class="string">&quot;org.springframework.boot.autoconfigure.jdbc.DataSourceProperties&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyCondition2</span> <span class="keyword">implements</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> !ClassUtils.isPresent(<span class="string">&quot;org.springframework.boot.autoconfigure.jdbc.DataSourceProperties&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Conditional(MyCondition1.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguration1</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Bean1 <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>(<span class="string">&quot;bean1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Conditional(MyCondition2.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguration2</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Bean2 <span class="title function_">bean2</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean2</span>(<span class="string">&quot;bean2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Bean1</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Bean2</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.ConfigurationClassPostProcessor</span><br><span class="line">dai.dawang.a42条件装配底层.a42$Config</span><br><span class="line">dai.dawang.a42条件装配底层.a42$AutoConfiguration1</span><br><span class="line">bean1</span><br></pre></td></tr></table></figure>

<p>项目导入了,所以MyCondition1 返回 ture,所以 AutoConfiguration1 的@Conditional 生效,所以导入 bean1</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="42-2-ConditionalOnXxx"><a href="#42-2-ConditionalOnXxx" class="headerlink" title="42.2@ConditionalOnXxx"></a>42.2@ConditionalOnXxx</h2><p> <code>@ConditionalOnXxx</code> 注解的使用，这种注解是将某个 <code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;@Conditional&lt;/font&gt;</code><font style="color:#DF2A3F;"> </font>的判断进行了封装，比如 <code>ConditionalOnClass</code> 就是用于判断某个 Class 是否存在。</p>
<p>因此针对上文中的代码可以做出修改：</p>
<p>自定义 <code>@ConditionalOnClass</code>注解,填入需要判断的全限定类名和判断条件</p>
<p>移除模拟的第三方配置上的 <code>@Conditional</code>注解,而是使用自定义的 <code>@ConditionalOnClass</code></p>
<p>重写 <code>Condition#matches() </code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: a42ConditionalOnXxx注解</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: <span class="doctag">@ConditionalOnXxx</span>注解的原理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: 呆大王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2024/9/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">a42ConditionalOnXxx</span>注解 &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        context.registerBean(ConfigurationClassPostProcessor.class);</span><br><span class="line">        context.registerBean(Config.class);</span><br><span class="line">        <span class="comment">/*        context.registerBean(AutoConfiguration1.class);</span></span><br><span class="line"><span class="comment">        context.registerBean(AutoConfiguration2.class);*/</span></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        Arrays.stream(context.getBeanDefinitionNames()).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="comment">//    @Import(&#123;AutoConfiguration1.class, AutoConfiguration2.class&#125;)</span></span><br><span class="line">    <span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;AutoConfiguration1.class.getName(), AutoConfiguration2.class.getName()&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConditionalOnBean</span> <span class="keyword">implements</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; annotationAttributes = metadata.getAnnotationAttributes(ConditionalOnClass.class.getName());</span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationAttributes.get(<span class="string">&quot;classNames&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">present</span> <span class="operator">=</span>Boolean.FALSE;</span><br><span class="line">            <span class="keyword">if</span> (ObjectUtil.isNotEmpty(o)) &#123;</span><br><span class="line">                List&lt;String&gt; collect = Arrays.stream((String[]) o).toList();</span><br><span class="line">                <span class="keyword">for</span> (String name : collect) &#123;</span><br><span class="line">                    present = ClassUtils.isPresent(name, <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">exits</span> <span class="operator">=</span> ((<span class="type">boolean</span>) annotationAttributes.get(<span class="string">&quot;exits&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> exits ? present : !present;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建自定义注解</span></span><br><span class="line">    <span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line">    <span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line">    <span class="meta">@Conditional(ConditionalOnBean.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="meta">@interface</span> ConditionalOnClass &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">exits</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>; <span class="comment">//true表示存在, false表示不存在</span></span><br><span class="line"></span><br><span class="line">        String[] classNames() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@ConditionalOnClass(classNames = &quot;org.springframework.boot.autoconfigure.jdbc.DataSourceProperties&quot;, exits = true)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguration1</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Bean1 <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>(<span class="string">&quot;bean1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@ConditionalOnClass(classNames = &quot;org.springframework.boot.autoconfigure.jdbc.DataSourceProperties&quot;, exits = false)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoConfiguration2</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Bean2 <span class="title function_">bean2</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean2</span>(<span class="string">&quot;bean2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Bean1</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Bean2</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于引入了 <code>&lt;font style=&quot;background-color:rgba(255, 255, 255, 0);&quot;&gt;mybatis-spring-boot-starte&lt;/font&gt;</code><font style="background-color:rgba(255, 255, 255, 0);"> 所以打印 bean1：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.ConfigurationClassPostProcessor</span><br><span class="line">dai.dawang.a42条件装配底层.a42ConditionalOnXxx注解$Config</span><br><span class="line">dai.dawang.a42条件装配底层.a42ConditionalOnXxx注解$AutoConfiguration1</span><br><span class="line">bean1</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://daidawang.github.io">呆大王</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://daidawang.github.io/2024/09/07/Spring%E5%9B%9B%E5%8D%81%E4%B9%9D%E8%AE%B2Springboot/">https://daidawang.github.io/2024/09/07/Spring%E5%9B%9B%E5%8D%81%E4%B9%9D%E8%AE%B2Springboot/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://daidawang.github.io" target="_blank">呆大王的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a></div><div class="post-share"><div class="social-share" data-image="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202409072209125.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2024/09/19/Spring%E5%9B%9B%E5%8D%81%E4%B9%9D%E8%AE%B2%E6%9D%82%E9%A1%B9/" title="Spring四十九讲杂项"><img class="cover" src="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202409191606396.jpg" onerror="onerror=null;src='/img/403.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring四十九讲杂项</div></div></a><a class="next-post pull-right" href="/2024/08/19/Spring%E5%9B%9B%E5%8D%81%E4%B9%9D%E8%AE%B2AOP/" title="Spring四十九讲AOP"><img class="cover" src="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202408292110316.jpg" onerror="onerror=null;src='/img/403.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring四十九讲AOP</div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="http://mms1.baidu.com/it/u=3426123179,1132541183&amp;fm=253&amp;app=120&amp;f=JPEG?w=801&amp;h=500" onerror="this.onerror=null;this.src='/img/ironheart.gif'" alt="avatar"/></div><div class="author-info-name">呆大王</div><div class="author-info-description">彩笔的打怪升级之路...</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/327975356"><i class="fab fa-bilibili"></i><span>关注我B站</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/daidawang" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://space.bilibili.com/327975356" target="_blank" title="哔哩哔哩"><i class="fab fa-bilibili" style="color: #FF6699;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本站所有博文均是博主的学习笔记与个人理解。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#37-Boot-%E9%AA%A8%E6%9E%B6%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">37.Boot 骨架项目</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#38-%E6%9E%84%E5%BB%BA-spring-war-%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.</span> <span class="toc-text">38.构建 spring war 项目</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#39-boot-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">39.boot 启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#39-1-SpringApplication-%E6%9E%84%E9%80%A0%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">39.1 SpringApplication 构造分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-BeanDefinition-%E6%BA%90"><span class="toc-number">3.1.1.</span> <span class="toc-text">获取 BeanDefinition 源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A8%E6%96%AD%E5%BA%94%E7%94%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">推断应用类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-ApplicationContext-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%99%A8"><span class="toc-number">3.1.3.</span> <span class="toc-text">添加 ApplicationContext 初始化器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">3.1.4.</span> <span class="toc-text">添加事件监听器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%B1%BB%E6%8E%A8%E6%96%AD"><span class="toc-number">3.1.5.</span> <span class="toc-text">主类推断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#39-2-SpringApplication-run-%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">39.2 SpringApplication run 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E5%BE%97%E5%88%B0-SpringApplicationRunListeners"><span class="toc-number">3.2.1.</span> <span class="toc-text">第一步 得到 SpringApplicationRunListeners</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E5%88%B0%E5%8D%81%E4%B8%80%E6%AD%A5-%E5%AE%8C%E6%88%90-Spring-%E5%AE%B9%E5%99%A8%E5%88%9B%E5%BB%BA"><span class="toc-number">3.2.2.</span> <span class="toc-text">第八到十一步 完成 Spring 容器创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E5%B0%81%E8%A3%85%E5%90%AF%E5%8A%A8-args"><span class="toc-number">3.2.3.</span> <span class="toc-text">第二步 封装启动 args</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%8C%E6%AD%A5-%E6%89%A7%E8%A1%8C-Runner"><span class="toc-number">3.2.4.</span> <span class="toc-text">第十二步 执行 Runner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E5%87%86%E5%A4%87-Environment-%E6%B7%BB%E5%8A%A0%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.5.</span> <span class="toc-text">第三步 准备 Environment 添加命令行参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.5.1.</span> <span class="toc-text">获取虚拟机参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.5.2.</span> <span class="toc-text">获取命令行参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96properties-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="toc-number">3.2.5.3.</span> <span class="toc-text">获取properties 配置文件信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.5.4.</span> <span class="toc-text">获取系统环境变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5-%E6%B7%BB%E5%8A%A0-ConfigurationPropertySources"><span class="toc-number">3.2.6.</span> <span class="toc-text">第四步 添加 ConfigurationPropertySources</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5-%E4%BD%BF%E7%94%A8EnvironmentPostProcessorApplicationListener-%E8%BF%9B%E8%A1%8C%E7%8E%AF%E5%A2%83%E5%AF%B9%E8%B1%A1%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86"><span class="toc-number">3.2.7.</span> <span class="toc-text">第五步 使用EnvironmentPostProcessorApplicationListener 进行环境对象后置处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5-%E7%BB%91%E5%AE%9A%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E5%88%B0-SpringApplication"><span class="toc-number">3.2.8.</span> <span class="toc-text">第六步 绑定配置信息到 SpringApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ConfigurationProperties-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.8.1.</span> <span class="toc-text">@ConfigurationProperties 注解的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E5%88%B0-SpringApplication"><span class="toc-number">3.2.8.2.</span> <span class="toc-text">绑定配置信息到 SpringApplication</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5-%E6%89%93%E5%8D%B0-Banner"><span class="toc-number">3.2.9.</span> <span class="toc-text">第七步 打印 Banner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E6%80%BB%E7%BB%93"><span class="toc-number">3.2.10.</span> <span class="toc-text">步骤总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#40-Tomcat-%E5%86%85%E5%B5%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">40.Tomcat 内嵌容器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#41-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">41.自动配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#41-1-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">41.1 自动配置原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Improt-%E7%9A%84-ImportSelector"><span class="toc-number">5.1.0.1.</span> <span class="toc-text">@Improt 的 ImportSelector</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot2-7-%E5%8F%8A%E5%85%B6%E4%BB%A5%E5%90%8E%E7%89%88%E6%9C%AC%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-number">5.1.1.</span> <span class="toc-text">SpringBoot2.7 及其以后版本的自动装配</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E5%85%85-Import-%E7%9A%84-Improt-%E7%9A%84-ImportBeanDefinitionRegistrar"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">补充 @Import 的@Improt 的 ImportBeanDefinitionRegistrar</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%BA%86%E5%86%B2%E7%AA%81%E7%9A%84-Bean"><span class="toc-number">5.1.2.</span> <span class="toc-text">定义了冲突的 Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">5.1.2.1.</span> <span class="toc-text"></span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#41-2-Aop-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.</span> <span class="toc-text">41.2 Aop 自动配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-1"><span class="toc-number">5.3.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#41-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3%E7%9A%84%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.4.</span> <span class="toc-text">41.3 数据库相关的自动配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DataSource-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.5.</span> <span class="toc-text">DataSource 自动配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mybatis-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.6.</span> <span class="toc-text">Mybatis 自动配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MybatisAutoConfiguration-%E7%9A%84%E6%9D%A1%E4%BB%B6%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.6.1.</span> <span class="toc-text">MybatisAutoConfiguration 的条件注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SqlSessionTemplate-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">5.6.2.</span> <span class="toc-text">SqlSessionTemplate 的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%B1%BBMapperScannerRegistrarNotFoundConfiguration"><span class="toc-number">5.6.3.</span> <span class="toc-text">内部类MapperScannerRegistrarNotFoundConfiguration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MapperScan-%E6%B3%A8%E8%A7%A3%E4%B8%8E-MybatisAutoConfiguration-%E5%9C%A8%E5%8A%9F%E8%83%BD%E5%8C%BA%E5%88%AB"><span class="toc-number">5.6.3.1.</span> <span class="toc-text">@MapperScan 注解与 MybatisAutoConfiguration 在功能区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.7.</span> <span class="toc-text">事务自动配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MVC-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.8.</span> <span class="toc-text">MVC 自动配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">5.9.</span> <span class="toc-text">自定义自动配置类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot2-7-0-%E5%8F%8A%E5%85%B6%E4%BB%A5%E5%90%8E%E7%89%88%E6%9C%AC"><span class="toc-number">5.9.1.</span> <span class="toc-text">SpringBoot2.7.0 及其以后版本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#42-%E6%9D%A1%E4%BB%B6%E8%A3%85%E9%85%8D%E5%BA%95%E5%B1%82"><span class="toc-number">6.</span> <span class="toc-text">42.条件装配底层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#42-1-Conditional"><span class="toc-number">6.1.</span> <span class="toc-text">42.1@Conditional</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#42-2-ConditionalOnXxx"><span class="toc-number">6.2.</span> <span class="toc-text">42.2@ConditionalOnXxx</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/17/%E7%AE%97%E5%8A%9B%E4%BA%92%E8%81%94%E4%BA%92%E9%80%9A/" title="无题">无题</a><time datetime="2025-02-17T02:36:40.570Z" title="发表于 2025-02-17 10:36:40">2025-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/12/%E5%A6%82%E4%BD%95%E6%A0%B9%E6%8D%AE%E7%BB%8F%E7%BA%AC%E5%BA%A6%E8%8E%B7%E5%8F%96%E5%88%B0%E8%A1%8C%E6%94%BF%E5%8C%BA%E5%88%92%E6%95%B0%E6%8D%AE/" title="如何根据经纬度获取到行政区划数据"><img src="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202408122226662.png" onerror="this.onerror=null;this.src='/img/403.png'" alt="如何根据经纬度获取到行政区划数据"/></a><div class="content"><a class="title" href="/2025/02/12/%E5%A6%82%E4%BD%95%E6%A0%B9%E6%8D%AE%E7%BB%8F%E7%BA%AC%E5%BA%A6%E8%8E%B7%E5%8F%96%E5%88%B0%E8%A1%8C%E6%94%BF%E5%8C%BA%E5%88%92%E6%95%B0%E6%8D%AE/" title="如何根据经纬度获取到行政区划数据">如何根据经纬度获取到行政区划数据</a><time datetime="2025-02-12T08:14:02.000Z" title="发表于 2025-02-12 16:14:02">2025-02-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/07/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%89%8D%E7%AB%AF%E5%8F%91%E7%89%88/" title="前端代码的发布"><img src="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202408122226662.png" onerror="this.onerror=null;this.src='/img/403.png'" alt="前端代码的发布"/></a><div class="content"><a class="title" href="/2025/02/07/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%89%8D%E7%AB%AF%E5%8F%91%E7%89%88/" title="前端代码的发布">前端代码的发布</a><time datetime="2025-02-07T06:36:33.000Z" title="发表于 2025-02-07 14:36:33">2025-02-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/22/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E8%A2%AB%E6%8C%96%E7%9F%BF/" title="记录一次服务器被挖矿"><img src="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202408122226662.png" onerror="this.onerror=null;this.src='/img/403.png'" alt="记录一次服务器被挖矿"/></a><div class="content"><a class="title" href="/2025/01/22/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E8%A2%AB%E6%8C%96%E7%9F%BF/" title="记录一次服务器被挖矿">记录一次服务器被挖矿</a><time datetime="2025-01-22T01:48:22.000Z" title="发表于 2025-01-22 09:48:22">2025-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/22/%E5%8F%91%E7%89%88%E4%B8%8E%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF/" title="发版与自动重启"><img src="https://daidawangblogbucket.oss-cn-beijing.aliyuncs.com/blog/202408122226662.png" onerror="this.onerror=null;this.src='/img/403.png'" alt="发版与自动重启"/></a><div class="content"><a class="title" href="/2024/10/22/%E5%8F%91%E7%89%88%E4%B8%8E%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF/" title="发版与自动重启">发版与自动重启</a><time datetime="2024-10-22T14:37:33.000Z" title="发表于 2024-10-22 22:37:33">2024-10-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By 呆大王</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://daidawang.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.0.0-b1"></script><script src="/js/main.js?v=5.0.0-b1"></script><div class="js-pjax"><script>(() => {
  const runMermaid = (ele) => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from(ele).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({svg}) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return
    
    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js').then(runMermaidFn)
  }
  
  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><div class="aplayer no-destroy" data-id="7427714271" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="true" muted></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="朝闻道，夕死可矣。,我善养吾浩然之气。,虽九死其犹未悔。,立志欲坚不欲锐，成功在久不在速。,伏清白以死直兮，固前圣之所厚。,事垂立而辄废，功未成而旋去。,合抱之木，生于毫末；九层之台，起于累土。,水之积也不厚，则其负大舟也无力。,靡不有初，鲜克有终。,凿井者，起于三寸之坎，以就万仞之深。" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

const triggerPjaxFn = (val) => {
  if (!val) return
  Object.values(val).forEach(fn => { fn() })
}

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjaxSendOnce')
  btf.removeGlobalFnEvent('themeChange')

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  triggerPjaxFn(window.globalFn.pjaxSend)
})

document.addEventListener('pjax:complete', () => {
  btf.removeGlobalFnEvent('pjaxCompleteOnce')
  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  triggerPjaxFn(window.globalFn.pjaxComplete)
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>